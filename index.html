<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂÆ∂Ë®àÁ∞ø</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        /* ----------------------------------------------------
        „Éá„Ç∂„Ç§„É≥„Çπ„Çø„Ç§„É´ (V8.09)
       ---------------------------------------------------- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #e0e0e0;
            padding-bottom: 50px;
            padding-top: calc(90px + env(safe-area-inset-top));
            user-select: none;
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            text-align: center;
        }

        .login-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .header-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #1b5e20;
            z-index: 1000;
            padding-top: env(safe-area-inset-top);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .app-title-bar {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #81c784;
            font-size: 0.9em;
        }

        .top-tabs {
            display: flex;
            width: 100%;
            height: 50px;
            background: #1b5e20;
        }

        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a5d6a7;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.2s;
            font-size: 1.05em;
        }

        .tab-item.active {
            color: #fff;
            border-bottom: 4px solid #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .container {
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 4px;
            table-layout: fixed;
            font-size: 0.95em;
        }

        th {
            color: #aaa;
            font-weight: normal;
            font-size: 0.85em;
            text-align: center;
            padding-bottom: 2px;
        }

        td {
            vertical-align: top;
            padding: 0 1px;
        }

        .col-date {
            width: 54px;
        }

        .col-money {
            width: 70px;
        }

        .col-btn {
            width: 68px;
        }

        .ctrl-container {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        input,
        textarea {
            box-sizing: border-box;
            border: 1px solid #444;
            background: #2a2a2a;
            border-radius: 3px;
            color: #fff;
            font-size: 1.1em;
            padding: 2px;
        }

        textarea.kakeibo-text {
            width: 100%;
            color: #eee;
            resize: none;
            line-height: 1.4em;
            min-height: 2.2em;
            white-space: pre-wrap;
            word-break: break-all;
            overflow: hidden;
            vertical-align: middle;
            padding: 4px 2px;
        }

        input {
            height: 2.2em;
        }

        input.day-input {
            text-align: center;
            width: 100%;
            font-family: monospace;
            font-weight: bold;
            padding: 2px 0;
        }

        input.date-input {
            text-align: center;
            width: 100%;
            font-family: monospace;
            font-weight: bold;
            padding: 0;
        }

        input.money-input {
            text-align: right;
            color: #80d8ff;
            width: 100%;
            font-family: monospace;
            font-weight: bold;
            letter-spacing: -0.5px;
            padding-right: 2px;
            font-size: 1.0em;
        }

        .mini-btn {
            width: 30px;
            height: 2.2em;
            padding: 0;
            margin: 0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.0em;
            cursor: pointer;
            border: 1px solid #555;
        }

        .btn-up {
            background: #333;
            color: #81c784;
            font-weight: bold;
        }

        .btn-del {
            background: #333;
            color: #e57373;
            font-weight: bold;
        }

        .memo-card {
            background: #202020;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .memo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .memo-card-title {
            font-weight: bold;
            color: #81c784;
            font-size: 1.2em;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }

        .memo-ctrl-btns {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .btn-edit-mode {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 0 12px;
            height: 32px;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .btn-icon {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            cursor: pointer;
        }

        .btn-toggle-memo {
            background: #1b5e20;
            color: #fff;
            border: 1px solid #4caf50;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            font-weight: bold;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .memo-card-body {
            font-family: 'Consolas', 'Monaco', monospace;
            color: #e0e0e0;
            font-size: 1.05em;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            border-top: 1px dashed #444;
            margin-top: 8px;
            padding-top: 8px;
        }

        .memo-card-body.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #888;
            border-top: none;
        }

        #memo-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 2000;
            padding-top: env(safe-area-inset-top);
            flex-direction: column;
        }

        #memo-editor.active {
            display: flex;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #202020;
            border-bottom: 1px solid #333;
        }

        input.memo-title-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            outline: none;
        }

        textarea.memo-body {
            flex: 1;
            width: 100%;
            background: #272727;
            color: #f0f0f0;
            border: none;
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: none;
            outline: none;
            box-sizing: border-box;
        }

        h2 {
            font-size: 1.2em;
            border-left: 6px solid #2e7d32;
            padding-left: 10px;
            margin: 20px 0 10px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-green {
            background: #2e7d32;
            color: #fff;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 8px 14px;
            font-size: 1em;
        }

        .btn-red {
            background: #c62828;
            color: #fff;
            border: 1px solid #e57373;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .btn-backup {
            background: #1565c0;
            color: #fff;
            border: 1px solid #42a5f5;
            border-radius: 4px;
            padding: 12px;
            font-size: 1.1em;
            width: 100%;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .btn-backup-sub {
            background: #424242;
            color: #ccc;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 12px;
            font-size: 1.1em;
            width: 100%;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .btn-year-ctrl {
            padding: 6px 12px;
            font-size: 0.9em;
            border-radius: 4px;
            color: #fff;
            margin-left: 5px;
            cursor: pointer;
        }

        .bg-green {
            background: #2e7d32;
            border: 1px solid #4caf50;
        }

        .bg-red {
            background: #c62828;
            border: 1px solid #e57373;
        }

        .btn-toggle {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            width: 34px;
            height: 34px;
            font-weight: bold;
            font-size: 1.2em;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .add-row-btn {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: #2e7d32;
            color: #fff;
            border: 1px solid #4caf50;
            border-radius: 4px;
            font-size: 1.1em;
            cursor: pointer;
        }

        input.summary-input {
            text-align: right;
            color: #80d8ff;
            width: 120px;
            height: 2.5em;
            font-family: monospace;
            font-weight: bold;
            letter-spacing: -0.5px;
            padding-right: 6px;
            font-size: 1.3em;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
        }

        #annual-section {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        .annual-group {
            margin-bottom: 30px;
        }

        .annual-header {
            font-weight: bold;
            color: #fff;
            border-bottom: 2px solid #2e7d32;
            margin-bottom: 10px;
            padding-bottom: 2px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .year-controls {
            background: #1f1f1f;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        select {
            font-size: 1.2em;
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
        }

        .month-selector {
            display: flex;
            overflow-x: auto;
            background: #000;
            margin-bottom: 15px;
            border: 1px solid #333;
            padding: 5px 0;
        }

        .month-btn {
            flex: 0 0 auto;
            padding: 12px 18px;
            color: #888;
            border-right: 1px solid #222;
            cursor: pointer;
        }

        .month-btn.active {
            background: #2e7d32;
            color: #fff;
            font-weight: bold;
            border: 1px solid #fff;
            border-radius: 2px;
        }

        .category-block {
            background: #1e1e1e;
            padding: 10px;
            margin-bottom: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .cat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            background: #2c2c2c;
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #444;
        }

        .cat-title-input {
            font-weight: bold;
            border: none !important;
            background: transparent !important;
            font-size: 1.4em;
            width: 5em;
            color: #fff;
            padding: 0;
        }

        .summary-area {
            display: flex;
            align-items: center;
            justify-content: space-around;
            background: #252525;
            padding: 10px 5px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #383838;
        }

        .summary-item {
            display: flex;
            align-items: center;
        }

        .summary-label {
            font-size: 1.1em;
            color: #ccc;
            margin-right: 10px;
            white-space: nowrap;
        }

        .add-block-area {
            text-align: center;
            margin-top: 30px;
            border-top: 1px dashed #444;
            padding-top: 20px;
        }

        .big-btn {
            background: #2e7d32;
            color: #fff;
            padding: 14px 24px;
            border: 1px solid #4caf50;
            border-radius: 5px;
            font-size: 1.1em;
            margin: 5px;
            width: 85%;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        .total-row td {
            vertical-align: middle;
        }

        .total-val-box {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            text-align: right;
            color: #fff;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.05em;
            padding: 4px;
            height: 2.0em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            letter-spacing: -0.5px;
        }

        .total-label {
            text-align: center;
            font-weight: bold;
            color: #fff;
            background: transparent;
            border: none;
            font-size: 1.1em;
        }

        #sync-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #aaa;
            background: #222;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0.7;
            z-index: 9999;
        }

        /* --- ToDo Styles --- */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
            gap: 12px;
        }

        .todo-item:last-child {
            border-bottom: none;
        }

        .todo-check-wrapper {
            position: relative;
            width: 24px;
            height: 24px;
        }

        .todo-check-wrapper input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .todo-checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
        }

        .todo-check-wrapper input:checked~.todo-checkmark {
            background: #2e7d32;
            border-color: #4caf50;
        }

        .todo-check-wrapper input:checked~.todo-checkmark::after {
            content: '‚úî';
            color: #fff;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .todo-text {
            flex: 1;
            font-size: 1.05em;
            color: #eee;
            transition: all 0.2s ease;
        }

        .todo-text.completed {
            color: #666;
            text-decoration: line-through;
        }

        .btn-todo-del {
            background: transparent;
            border: none;
            color: #e57373;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            padding: 0 5px;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:#81c784; margin-bottom:30px;">ÂÆ∂Ë®àÁ∞ø</h1>
            <button class="login-btn" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                Google„Åß„É≠„Ç∞„Ç§„É≥
            </button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div class="header-area">
            <div class="app-title-bar">ÂÆ∂Ë®àÁ∞ø</div>
            <div class="top-tabs">
                <div class="tab-item" onclick="switchView('todo')" id="tab-todo">‚úÖ ToDo</div>
                <div class="tab-item" onclick="switchView('memo')" id="tab-memo">üìù „É°„É¢</div>
                <div class="tab-item" onclick="switchView('fixed')" id="tab-fixed">üè¢ Âõ∫ÂÆöË≤ª</div>
                <div class="tab-item active" onclick="switchView('kakeibo')" id="tab-kakeibo">üí∞ ÂèéÊîØ</div>
                <div class="tab-item" onclick="switchView('save')" id="tab-save">üíæ ‰øùÂ≠ò</div>
            </div>
        </div>

        <div class="container">

            <div id="view-todo" class="view-section">
                <div class="memo-card">
                    <div class="memo-card-header">
                        <span class="memo-card-title">ToDo„É™„Çπ„Éà</span>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <input type="text" id="todo-input" placeholder="Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ..." style="flex:1; height:2.5em;">
                        <button class="btn-green" style="width:60px; height:2.5em;" onclick="addTodo()">ËøΩÂä†</button>
                    </div>
                    <div id="todo-list" style="margin-top:15px;"></div>
                </div>
            </div>

            <div id="view-memo" class="view-section">
                <div id="memo-list-view">
                    <button class="add-row-btn" onclick="addNewMemo()">Ôºã Êñ∞„Åó„ÅÑ„É°„É¢„ÇíËøΩÂä†</button>
                    <div id="memo-list-container" style="margin-top:15px;"></div>
                </div>
                <div id="memo-editor">
                    <div class="editor-toolbar">
                        <button class="btn-green" onclick="closeMemoEditor()">Ôºú Êàª„Çã</button>
                        <button class="btn-red" onclick="deleteCurrentMemo()">ÂâäÈô§</button>
                    </div>
                    <input type="text" id="memo-edit-title" class="memo-title-input" placeholder="„Çø„Ç§„Éà„É´"
                        onblur="saveCurrentMemo()">
                    <textarea id="memo-edit-body" class="memo-body" placeholder="ÂÜÖÂÆπ„ÇíÂÖ•Âäõ..."
                        onblur="saveCurrentMemo()"></textarea>
                </div>
            </div>

            <div id="view-fixed" class="view-section">
                <h2>Âõ∫ÂÆöË≤ª</h2>
                <div id="annual-section">
                    <div class="annual-group">
                        <div class="annual-header">
                            <span>Âπ¥Èñì</span>
                            <button class="btn-toggle" onclick="toggleAnnualSub('year')" id="btn-annual-year">Ôºç</button>
                        </div>
                        <div id="content-annual-year">
                            <div id="annual-table-year"></div>
                            <button class="add-row-btn" onclick="addAnnualItem('year')">ËøΩÂä†</button>
                        </div>
                    </div>
                    <div class="annual-group">
                        <div class="annual-header">
                            <span>ÊúàÈñì</span>
                            <button class="btn-toggle" onclick="toggleAnnualSub('month')"
                                id="btn-annual-month">Ôºç</button>
                        </div>
                        <div id="content-annual-month">
                            <div id="annual-table-month"></div>
                            <button class="add-row-btn" onclick="addAnnualItem('month')">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-kakeibo" class="view-section active">
                <div class="year-controls">
                    <select id="year-select" onchange="changeYear()"></select>
                    <div>
                        <button class="btn-year-ctrl bg-green" onclick="addNewYear()">ËøΩÂä†</button>
                        <button class="btn-year-ctrl bg-red" onclick="deleteYear()">ÂâäÈô§</button>
                    </div>
                </div>
                <div class="month-selector" id="month-tabs"></div>
                <h2 id="monthly-header-title">1Êúà„ÅÆÂèéÊîØ</h2>
                <div id="monthly-container"></div>
                <div class="add-block-area">
                    <button class="big-btn" onclick="addCategoryBlock('standard')">„É™„Çπ„Éà1„ÇíËøΩÂä†</button>
                    <button class="big-btn" onclick="addCategoryBlock('detail')">„É™„Çπ„Éà2„ÇíËøΩÂä†</button>
                </div>
            </div>

            <div id="view-save" class="view-section">
                <div class="settings-menu">
                    <h2 style="border:none; justify-content:center;">„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                    <button class="btn-backup" onclick="shareDataText()">üì§ „Éá„Éº„Çø„ÇíÊõ∏„ÅçÂá∫„Åó (ÂÖ±Êúâ)</button>
                    <button class="btn-backup" style="background:#00695c; border-color:#00897b;"
                        onclick="exportDataToClipboard()">üìã „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº</button>
                    <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
                    <textarea id="backup-box" style="width:100%; height:100px; background:#2a2a2a; color:#fff;"
                        placeholder="„Åì„Åì„Å´„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶Âæ©ÂÖÉ"></textarea>
                    <button class="btn-backup-sub" onclick="importDataFromText()">üìÇ „Éá„Éº„Çø„ÇíÂæ©ÂÖÉ (Ë™≠„ÅøËæº„Åø)</button>
                    <button onclick="logout()"
                        style="width:100%; margin-top:30px; background:#444; color:#ccc; border:none; padding:10px; cursor:pointer; border-radius:4px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sync-status">ÂêåÊúüÂæÖÊ©ü‰∏≠...</div>

    <script>
        // kakeibo_V10.0 (ToDo Tab Integration)

        // --- Service Worker Cleanup ---
        if (window.navigator && navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) { registration.unregister(); }
            });
        }

        // --- FirebaseË®≠ÂÆö ---
        const firebaseConfig = {
            apiKey: "AIzaSyCT_VvEPzGCPRLLFnzQuwArsYn2JnUR_fg",
            authDomain: "kakeibo-app-92bb4.firebaseapp.com",
            databaseURL: "https://kakeibo-app-92bb4-default-rtdb.firebaseio.com",
            projectId: "kakeibo-app-92bb4",
            storageBucket: "kakeibo-app-92bb4.firebasestorage.app",
            messagingSenderId: "45651637804",
            appId: "1:45651637804:web:f30ba95891d28538a14389"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let dbRef = null;

        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        const initialData = {
            currentYear: "2025",
            lastViewedTab: "kakeibo",
            years: { "2025": createNewYearData() },
            freeMemos: [],
            todos: []
        };

        let data = JSON.parse(JSON.stringify(initialData));
        let isDataLoaded = false;
        let editingMemoId = null;

        auth.onAuthStateChanged((user) => {
            const loginScr = document.getElementById('login-screen');
            const mainApp = document.getElementById('main-app');
            const statusEl = document.getElementById('sync-status');
            if (user) {
                loginScr.style.display = 'none';
                mainApp.style.display = 'block';
                dbRef = db.ref('kakeiboData');
                initApp();
            } else {
                loginScr.style.display = 'flex';
                mainApp.style.display = 'none';
                statusEl.innerText = "„É≠„Ç∞„Ç§„É≥ÂæÖÊ©ü‰∏≠";
            }
        });

        async function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            try { await auth.signInWithPopup(provider); } catch (e) { console.error(e); }
        }

        function logout() {
            if (confirm("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü")) {
                auth.signOut().then(() => { location.reload(); });
            }
        }

        function initApp() {
            if (!dbRef) return;
            dbRef.on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    data = val;
                    if (!data.years) data = JSON.parse(JSON.stringify(initialData));
                    if (!data.freeMemos) data.freeMemos = [];
                    if (!data.todos) data.todos = [];
                }
                isDataLoaded = true;
                switchView(data.lastViewedTab || 'kakeibo');
                if (!document.getElementById('memo-editor').classList.contains('active')) renderMemoList();
                renderTodos();
                const statusEl = document.getElementById('sync-status');
                if (statusEl) { statusEl.innerText = "‚óè ÂêåÊúüÂÆå‰∫Ü"; setTimeout(() => { statusEl.innerText = ""; }, 2000); }
            });
        }

        function saveData(syncAnnual = false) {
            if (!isDataLoaded || !dbRef) return;
            if (syncAnnual) {
                const currentY = data.years[data.currentYear];
                Object.keys(data.years).forEach(y => {
                    if (y !== data.currentYear && data.years[y]) {
                        data.years[y].annualYear = JSON.parse(JSON.stringify(currentY.annualYear));
                        data.years[y].annualMonth = JSON.parse(JSON.stringify(currentY.annualMonth));
                    }
                });
            }
            dbRef.set(data);
            localStorage.setItem('kakeiboDataV7_Backup', JSON.stringify(data));
            const el = document.getElementById('sync-status');
            if (el) el.innerText = "‚Üë ÈÄÅ‰ø°‰∏≠...";
        }

        function createNewYearData() {
            let months = {};
            for (let i = 1; i <= 12; i++) {
                months[i] = [
                    { type: "standard", title: "ÈÄöÂ∏≥", isOpen: true, items: [], balance: 0, deposit: 0 },
                    { type: "standard", title: "Ë≤°Â∏É", isOpen: true, items: [], balance: 0, deposit: 0 },
                    { type: "detail", title: "Á´∂È¶¨", isOpen: true, items: [] }
                ];
            }
            return { annualYear: [], annualMonth: [], isAnnualYearOpen: true, isAnnualMonthOpen: true, activeMonth: 1, months: months };
        }

        window.switchView = (viewName) => {
            if (viewName !== 'memo') closeMemoEditor();
            ['todo', 'memo', 'fixed', 'kakeibo', 'save'].forEach(v => {
                const tab = document.getElementById(`tab-${v}`);
                const sec = document.getElementById(`view-${v}`);
                if (tab) tab.classList.remove('active');
                if (sec) sec.classList.remove('active');
            });
            const activeTab = document.getElementById(`tab-${viewName}`);
            const activeSec = document.getElementById(`view-${viewName}`);
            if (activeTab) activeTab.classList.add('active');
            if (activeSec) activeSec.classList.add('active');
            data.lastViewedTab = viewName;
            if (viewName === 'kakeibo' || viewName === 'fixed') renderKakeibo();
            if (viewName === 'memo') renderMemoList();
            if (viewName === 'todo') renderTodos();
            if (isDataLoaded) saveData();
        };

        // ToDo„É≠„Ç∏„ÉÉ„ÇØ
        window.addTodo = () => {
            const input = document.getElementById('todo-input');
            const text = input.value.trim();
            if (!text) return;
            data.todos.push({ id: Date.now().toString(), text: text, completed: false });
            input.value = '';
            saveData(); renderTodos();
        };
        window.renderTodos = () => {
            const list = document.getElementById('todo-list');
            if (!list) return;
            list.innerHTML = '';
            data.todos.forEach(todo => {
                const div = document.createElement('div'); div.className = 'todo-item';
                div.innerHTML = `
                <div class="todo-check-wrapper">
                    <input type="checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo('${todo.id}')">
                    <div class="todo-checkmark" onclick="this.previousElementSibling.click()"></div>
                </div>
                <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
                <button class="btn-todo-del" onclick="deleteTodo('${todo.id}')">√ó</button>
            `;
                list.appendChild(div);
            });
        };
        window.toggleTodo = (id) => {
            const t = data.todos.find(x => x.id === id);
            if (t) { t.completed = !t.completed; saveData(); renderTodos(); }
        };
        window.deleteTodo = (id) => {
            if (confirm("„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                data.todos = data.todos.filter(x => x.id !== id);
                saveData(); renderTodos();
            }
        };

        // „É°„É¢Â∏≥„É≠„Ç∏„ÉÉ„ÇØ
        window.addNewMemo = () => {
            const newId = Date.now().toString();
            data.freeMemos.push({ id: newId, title: "Êñ∞Ë¶è„É°„É¢", body: "", isOpen: true });
            saveData(); openMemoEditor(newId);
        };
        window.renderMemoList = () => {
            const container = document.getElementById('memo-list-container');
            if (!container) return;
            container.innerHTML = '';
            data.freeMemos.forEach((memo) => {
                const div = document.createElement('div'); div.className = 'memo-card';
                div.innerHTML = `<div class="memo-card-header"><span class="memo-card-title">${memo.title}</span><div class="memo-ctrl-btns">
                <button class="btn-edit-mode" onclick="openMemoEditor('${memo.id}')">‚úê Á∑®ÈõÜ</button>
                <button class="btn-icon" onclick="moveMemo('${memo.id}','up')">‚Üë</button>
                <button class="btn-toggle-memo" onclick="toggleMemo('${memo.id}')">${memo.isOpen ? 'Ôºç' : 'Ôºã'}</button>
            </div></div><div class="memo-card-body ${memo.isOpen ? '' : 'collapsed'}">${memo.body}</div>`;
                container.appendChild(div);
            });
        };
        window.moveMemo = (id, dir) => {
            const i = data.freeMemos.findIndex(m => m.id === id);
            if (dir === 'up' && i > 0) [data.freeMemos[i], data.freeMemos[i - 1]] = [data.freeMemos[i - 1], data.freeMemos[i]];
            saveData(); renderMemoList();
        };
        window.toggleMemo = (id) => {
            const m = data.freeMemos.find(m => m.id === id);
            if (m) { m.isOpen = !m.isOpen; saveData(); renderMemoList(); }
        };
        window.openMemoEditor = (id) => {
            editingMemoId = id; const m = data.freeMemos.find(m => m.id === id); if (!m) return;
            document.getElementById('memo-list-view').style.display = 'none';
            document.getElementById('memo-editor').classList.add('active');
            document.getElementById('memo-edit-title').value = m.title;
            document.getElementById('memo-edit-body').value = m.body;
        };
        window.closeMemoEditor = () => {
            saveCurrentMemo(); editingMemoId = null;
            document.getElementById('memo-editor').classList.remove('active');
            document.getElementById('memo-list-view').style.display = 'block';
            renderMemoList();
        };
        window.saveCurrentMemo = () => {
            if (!editingMemoId) return; const m = data.freeMemos.find(m => m.id === editingMemoId);
            if (m) { m.title = document.getElementById('memo-edit-title').value; m.body = document.getElementById('memo-edit-body').value; saveData(); }
        };
        window.deleteCurrentMemo = () => {
            if (confirm("ÂâäÈô§Ôºü")) { data.freeMemos = data.freeMemos.filter(m => m.id !== editingMemoId); saveData(); closeMemoEditor(); }
        };

        // ÂÆ∂Ë®àÁ∞øÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØ
        function renderKakeibo() {
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = '';
            Object.keys(data.years).sort().forEach(y => {
                const op = document.createElement('option'); op.value = y; op.innerText = y + "Âπ¥";
                if (y === data.currentYear) op.selected = true; yearSelect.appendChild(op);
            });
            const yd = data.years[data.currentYear];
            const activeMonth = yd.activeMonth || 1;
            document.getElementById('btn-annual-year').innerText = yd.isAnnualYearOpen ? 'Ôºç' : 'Ôºã';
            document.getElementById('content-annual-year').className = yd.isAnnualYearOpen ? '' : 'hidden';
            document.getElementById('btn-annual-month').innerText = yd.isAnnualMonthOpen ? 'Ôºç' : 'Ôºã';
            document.getElementById('content-annual-month').className = yd.isAnnualMonthOpen ? '' : 'hidden';
            renderAnnualTable('annual-table-year', yd.annualYear, 'annualYear');
            renderAnnualTable('annual-table-month', yd.annualMonth, 'annualMonth');
            const tabs = document.getElementById('month-tabs'); tabs.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const d = document.createElement('div'); d.className = `month-btn ${activeMonth === i ? 'active' : ''}`;
                d.innerText = i + "Êúà"; d.onclick = () => { yd.activeMonth = i; saveData(); renderKakeibo(); }; tabs.appendChild(d);
            }
            document.getElementById('monthly-header-title').innerText = `${activeMonth}Êúà„ÅÆÂèéÊîØ`;
            renderMonthlyBlocks(yd, activeMonth);
        }

        function renderAnnualTable(cid, list, key) {
            const c = document.getElementById(cid); c.innerHTML = '';
            const t = document.createElement('table');
            t.innerHTML = `<thead><tr><th class="col-date">Êó•‰ªò</th><th>ÂÜÖÂÆπ</th><th class="col-money">ÈáëÈ°ç</th><th class="col-btn"></th></tr></thead>`;
            const tb = document.createElement('tbody');
            (list || []).forEach((item, idx) => {
                const tr = document.createElement('tr');
                const tdD = document.createElement('td'); tdD.appendChild(createInp(item.date, v => { data.years[data.currentYear][key][idx].date = v; saveData(true); }, key === 'annualYear' ? 'date' : 'day'));
                const tdT = document.createElement('td'); tdT.appendChild(createTxt(item.text, v => { data.years[data.currentYear][key][idx].text = v; saveData(true); }));
                const tdC = document.createElement('td'); tdC.appendChild(createMon(item.cost, v => { data.years[data.currentYear][key][idx].cost = v; saveData(true); }));
                const tdCtl = document.createElement('td');
                tdCtl.innerHTML = `<div class="ctrl-container">${idx > 0 ? `<button class="mini-btn btn-up" onclick="moveAnn('${key}',${idx})">‚ñ≤</button>` : `<div style="width:30px"></div>`}<button class="mini-btn btn-del" onclick="delAnn('${key}',${idx})">√ó</button></div>`;
                tr.append(tdD, tdT, tdC, tdCtl); tb.appendChild(tr);
            });
            t.appendChild(tb); c.appendChild(t);
        }

        function renderMonthlyBlocks(yd, m) {
            const c = document.getElementById('monthly-container'); c.innerHTML = '';
            (yd.months[m] || []).forEach((b, bi) => {
                const d = document.createElement('div'); d.className = 'category-block';
                d.innerHTML = `<div class="cat-header"><input type="text" class="cat-title-input" value="${b.title}" onchange="data.years[data.currentYear].months[${m}][${bi}].title=this.value;saveData()"><div style="display:flex;gap:5px;"><button class="btn-red" onclick="delBk(${bi},${m})">ÂâäÈô§</button><button class="btn-toggle" onclick="togBk(${bi},${m})">${b.isOpen ? 'Ôºç' : 'Ôºã'}</button></div></div>`;
                if (b.isOpen) {
                    const inner = document.createElement('div');
                    if (b.type === 'standard') {
                        inner.innerHTML = `<div class="summary-area"><div class="summary-item"><span class="summary-label">ÊÆãÈ´ò</span><div id="bal-${bi}"></div></div><div class="summary-item"><span class="summary-label">ÂÖ•„Çå„ÇãÈ°ç</span><div id="dep-${bi}"></div></div></div>`;
                        const balBox = inner.querySelector(`#bal-${bi}`);
                        const depBox = inner.querySelector(`#dep-${bi}`);
                        balBox.appendChild(createMon(b.balance, v => { data.years[data.currentYear].months[m][bi].balance = v; saveData(); }, null, true));
                        depBox.appendChild(createMon(b.deposit, v => { data.years[data.currentYear].months[m][bi].deposit = v; saveData(); }, null, true));
                    }
                    const t = document.createElement('table');
                    t.innerHTML = b.type === 'standard' ? `<thead><tr><th class="col-date">Êó•‰ªò</th><th>ÂÜÖÂÆπ</th><th class="col-money">‰∫àÂÆö</th><th class="col-money">Á¢∫ÂÆö</th><th class="col-btn"></th></tr></thead>` : `<thead><tr><th class="col-date">Êó•‰ªò</th><th>ÈáçË≥ûÂêç</th><th class="col-money">ÂÖ•Èáë</th><th class="col-money">ÊâïÊàª</th><th class="col-btn"></th></tr></thead>`;
                    const tb = document.createElement('tbody');
                    (b.items || []).forEach((it, ii) => {
                        const tr = document.createElement('tr');
                        const tdD = document.createElement('td'); tdD.appendChild(createInp(it.date, v => { data.years[data.currentYear].months[m][bi].items[ii].date = v; saveData(); }, 'date'));
                        const tdN = document.createElement('td'); tdN.appendChild(createTxt(it.name, v => { data.years[data.currentYear].months[m][bi].items[ii].name = v; saveData(); }));
                        tr.append(tdD, tdN);
                        if (b.type === 'standard') {
                            tr.appendChild(createMonTd(it.plan, v => { data.years[data.currentYear].months[m][bi].items[ii].plan = v; saveData(); }, bi, m));
                            tr.appendChild(createMonTd(it.act, v => { data.years[data.currentYear].months[m][bi].items[ii].act = v; saveData(); }, bi, m));
                        } else {
                            tr.appendChild(createMonTd(it.out, v => { data.years[data.currentYear].months[m][bi].items[ii].out = v; saveData(); }, bi, m));
                            tr.appendChild(createMonTd(it.in, v => { data.years[data.currentYear].months[m][bi].items[ii].in = v; saveData(); }, bi, m));
                        }
                        const tdCtl = document.createElement('td');
                        tdCtl.innerHTML = `<div class="ctrl-container">${ii > 0 ? `<button class="mini-btn btn-up" onclick="moveIt(${bi},${ii},${m},'up')">‚ñ≤</button>` : `<div style="width:30px"></div>`}<button class="mini-btn btn-del" onclick="delIt(${bi},${ii},${m})">√ó</button></div>`;
                        tr.append(tdCtl); tb.appendChild(tr);
                    });
                    const totalTr = document.createElement('tr'); totalTr.className = 'total-row';
                    totalTr.innerHTML = b.type === 'standard' ? `<td></td><td class="total-label">ÂêàË®à</td><td><div class="total-val-box" id="t1-${bi}">0</div></td><td><div class="total-val-box" id="t2-${bi}">0</div></td><td></td>` : `<td></td><td class="total-label">ÂêàË®à</td><td><div class="total-val-box" id="t1-${bi}">0</div></td><td><div class="total-val-box" id="t2-${bi}">0</div></td><td></td>`;
                    tb.appendChild(totalTr); t.appendChild(tb); inner.appendChild(t); inner.appendChild(createAddRowBtn(() => addIt(bi, m))); d.appendChild(inner);
                    setTimeout(() => updateTotalDisplay(bi, m), 0);
                }
                c.appendChild(d);
            });
        }

        function createMonTd(v, cb, bi, m) { const td = document.createElement('td'); td.appendChild(createMon(v, cb, () => updateTotalDisplay(bi, m))); return td; }
        function updateTotalDisplay(bi, m) {
            const b = data.years[data.currentYear].months[m][bi]; let s1 = 0, s2 = 0;
            (b.items || []).forEach(it => { if (b.type === 'standard') { s1 += Number(it.plan || 0); s2 += Number(it.act || 0); } else { s1 += Number(it.out || 0); s2 += Number(it.in || 0); } });
            const e1 = document.getElementById(`t1-${bi}`), e2 = document.getElementById(`t2-${bi}`);
            if (e1) e1.innerText = formatNum(s1); if (e2) e2.innerText = formatNum(s2);
        }
        function createInp(v, cb, type) {
            const i = document.createElement('input'); i.value = v || "";
            if (type === 'date') { i.className = "date-input"; i.onblur = function () { this.value = formatDateAnnual(this.value); cb(this.value); }; }
            else { i.type = "tel"; i.className = "day-input"; i.oninput = function () { this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2); }; i.onblur = function () { cb(this.value); }; }
            return i;
        }
        function createTxt(v, cb) {
            const t = document.createElement('textarea'); t.className = "kakeibo-text"; t.value = v || ""; t.rows = 1;
            t.oninput = function () { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; };
            t.onblur = function () { cb(this.value); }; setTimeout(() => t.oninput(), 0); return t;
        }
        function createMon(v, cb, bCb, isBig) {
            const i = document.createElement('input'); i.type = "tel"; i.className = isBig ? "summary-input" : "money-input";
            i.value = (v === 0 || v === "0") ? "" : Number(v).toLocaleString();
            i.onfocus = function () { this.value = this.value.replace(/,/g, ''); this.select(); };
            i.onblur = function () {
                let n = parseInt(this.value.replace(/[^0-9\-]/g, '')) || 0;
                cb(n); this.value = n ? n.toLocaleString() : ""; if (bCb) bCb();
            }; return i;
        }
        function createAddRowBtn(fn) { const b = document.createElement('button'); b.className = 'add-row-btn'; b.innerText = 'ËøΩÂä†'; b.onclick = fn; return b; }

        function formatDateAnnual(v) {
            const nums = v.replace(/[^0-9]/g, '');
            if (nums.length === 4) return parseInt(nums.slice(0, 2)) + "/" + parseInt(nums.slice(2, 4));
            if (nums.length === 3) {
                let m12 = parseInt(nums.slice(0, 2));
                if (m12 >= 10 && m12 <= 12) { return m12 + "/" + parseInt(nums.slice(2, 3)); }
                else { return parseInt(nums.slice(0, 1)) + "/" + parseInt(nums.slice(1, 3)); }
            }
            return v;
        }

        function formatNum(n) { return Number(n).toLocaleString(); }

        window.addAnnualItem = (k) => { const key = k === 'year' ? 'annualYear' : 'annualMonth'; data.years[data.currentYear][key].push({ date: "", text: "", cost: 0 }); saveData(true); renderKakeibo(); };
        window.moveAnn = (k, idx) => { const l = data.years[data.currentYear][k]; if (idx > 0) [l[idx], l[idx - 1]] = [l[idx - 1], l[idx]]; saveData(true); renderKakeibo(); };
        window.delAnn = (k, idx) => { if (confirm("ÂâäÈô§Ôºü")) { data.years[data.currentYear][k].splice(idx, 1); saveData(true); renderKakeibo(); } };
        window.toggleAnnualSub = (t) => { if (t === 'year') data.years[data.currentYear].isAnnualYearOpen = !data.years[data.currentYear].isAnnualYearOpen; else data.years[data.currentYear].isAnnualMonthOpen = !data.years[data.currentYear].isAnnualMonthOpen; saveData(); renderKakeibo(); };
        window.togBk = (bi, m) => { data.years[data.currentYear].months[m][bi].isOpen = !data.years[data.currentYear].months[m][bi].isOpen; saveData(); renderKakeibo(); };
        window.addCategoryBlock = (t) => { const yd = data.years[data.currentYear]; const m = yd.activeMonth; data.years[data.currentYear].months[m].push({ type: t, title: t === 'standard' ? '„É™„Çπ„Éà1' : '„É™„Çπ„Éà2', isOpen: true, items: [], balance: 0, deposit: 0 }); saveData(); renderKakeibo(); };
        window.delBk = (bi, m) => { if (confirm("ÂâäÈô§Ôºü")) { data.years[data.currentYear].months[m].splice(bi, 1); saveData(); renderKakeibo(); } };
        window.addIt = (bi, m) => { const b = data.years[data.currentYear].months[m][bi]; b.items.push(b.type === 'standard' ? { date: "", name: "", plan: 0, act: 0 } : { date: "", name: "", out: 0, in: 0 }); saveData(); renderKakeibo(); };
        window.moveIt = (bi, ii, m, dir) => { const l = data.years[data.currentYear].months[m][bi].items; if (dir === 'up' && ii > 0) [l[ii], l[ii - 1]] = [l[ii - 1], l[ii]]; saveData(); renderKakeibo(); };
        window.delIt = (bi, ii, m) => { if (confirm("ÂâäÈô§Ôºü")) { data.years[data.currentYear].months[m][bi].items.splice(ii, 1); saveData(); renderKakeibo(); } };
        window.changeYear = () => { data.currentYear = document.getElementById('year-select').value; renderKakeibo(); };
        window.addNewYear = () => { let n = prompt("Ë•øÊö¶„ÇíÂÖ•Âäõ"); if (n && !data.years[n]) { data.years[n] = createNewYearData(); data.currentYear = n; saveData(); renderKakeibo(); } };
        window.deleteYear = () => { if (Object.keys(data.years).length > 1 && confirm("ÂâäÈô§Ôºü")) { delete data.years[data.currentYear]; data.currentYear = Object.keys(data.years)[0]; saveData(); renderKakeibo(); } };

        window.shareDataText = async () => { const s = JSON.stringify(data); if (navigator.share) await navigator.share({ title: 'ÂÆ∂Ë®àÁ∞ø', text: s }); else alert(s); };
        window.exportDataToClipboard = () => { navigator.clipboard.writeText(JSON.stringify(data)); alert("„Ç≥„Éî„ÉºÂÆå‰∫Ü"); };
        window.importDataFromText = () => { try { const s = document.getElementById('backup-box').value; if (s) { data = JSON.parse(s); saveData(); location.reload(); } } catch (e) { alert("„Ç®„É©„Éº"); } };

        document.getElementById('sync-status').innerText = "Êé•Á∂ö‰∏≠...";
    </script>
</body>

</html>