<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂÆ∂Ë®àÁ∞ø</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        /* --- Âü∫Êú¨„Éá„Ç∂„Ç§„É≥ (V8.11„Éô„Éº„Çπ) --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #121212;
            color: #e0e0e0;
            padding-bottom: 50px;
            padding-top: calc(90px + env(safe-area-inset-top));
            user-select: none;
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .login-box {
            text-align: center;
        }

        .login-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .header-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #1b5e20;
            z-index: 1000;
            padding-top: env(safe-area-inset-top);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .app-title-bar {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #81c784;
            font-size: 0.9em;
        }

        .top-tabs {
            display: flex;
            width: 100%;
            height: 50px;
            background: #1b5e20;
        }

        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a5d6a7;
            font-weight: bold;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .tab-item.active {
            color: #fff;
            border-bottom: 4px solid #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .container {
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- „ÉÜ„Éº„Éñ„É´„ÉªÂÖ•Âäõ„Éª„Éú„Çø„É≥Ë™øÊï¥ --- */
        table {
            display: table !important;
            width: 100% !important;
            border-collapse: separate;
            border-spacing: 0 4px;
            table-layout: fixed !important;
            font-size: 0.9em;
        }

        th {
            color: #aaa;
            font-weight: normal;
            font-size: 0.8em;
            text-align: center;
        }

        tr {
            display: table-row !important;
        }

        td {
            display: table-cell !important;
            vertical-align: top;
            padding: 0 1px;
        }

        .col-date {
            width: 28px !important;
        }

        /* Ê•µÁ¥∞Êó•‰ªòÊ¨Ñ */
        .col-money {
            width: 72px;
        }

        .col-btn {
            width: 56px;
        }

        .ctrl-container {
            display: flex;
            gap: 2px;
            justify-content: center;
            align-items: center;
            height: 2.2em;
        }

        input,
        textarea {
            box-sizing: border-box;
            border: 1px solid #444;
            background: #2a2a2a;
            border-radius: 3px;
            color: #fff;
            font-size: 1.1em;
            padding: 2px;
            outline: none;
        }

        textarea.kakeibo-text {
            width: 10em !important;
            color: #eee;
            resize: none;
            line-height: 1.4em;
            min-height: 2.2em;
            white-space: pre-wrap !important;
            word-break: break-all !important;
            overflow: hidden;
            vertical-align: middle;
            padding: 4px 2px;
            font-size: 1.0em;
        }

        input {
            height: 2.2em;
        }

        input.day-input {
            text-align: center;
            width: 100%;
            font-family: monospace;
            font-weight: bold;
            padding: 2px 0;
            font-size: 0.9em;
        }

        input.date-input {
            text-align: center;
            width: 100%;
            font-family: monospace;
            font-weight: bold;
            padding: 0;
            font-size: 0.9em;
        }

        input.money-input {
            text-align: right;
            color: #80d8ff;
            width: 100%;
            font-family: monospace;
            font-weight: bold;
            letter-spacing: -1px;
            padding-right: 2px;
            font-size: 0.95em;
        }

        .mini-btn {
            width: 26px;
            height: 22px;
            padding: 0;
            margin: 0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            cursor: pointer;
            border: 1px solid #555;
        }

        .btn-up {
            background: #333;
            color: #81c784;
            font-weight: bold;
        }

        .btn-del {
            background: #c62828 !important;
            color: #fff !important;
            font-weight: bold;
            border: 1px solid #e57373;
        }

        /* ÂâäÈô§„Éú„Çø„É≥Ëµ§Ëâ≤Âåñ */

        /* --- „É°„É¢„ÉªToDo „Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ --- */
        .memo-card {
            background: #202020;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .memo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .memo-card-title {
            font-weight: bold;
            color: #81c784;
            font-size: 1.1em;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }

        .memo-ctrl-btns {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .btn-edit-mode {
            background: #3949ab !important;
            color: #fff !important;
            border: 1px solid #5c6bc0;
            border-radius: 4px;
            padding: 0 10px;
            height: 28px;
            font-size: 0.85em;
            cursor: pointer;
        }

        .btn-icon {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.0em;
            cursor: pointer;
        }

        .btn-toggle-memo {
            background: #1b5e20;
            color: #fff;
            border: 1px solid #4caf50;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .memo-card-body {
            font-family: monospace;
            color: #e0e0e0;
            font-size: 1.0em;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            border-top: 1px dashed #444;
            margin-top: 6px;
            padding-top: 6px;
        }

        .memo-card-body.collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #888;
            border-top: none;
        }

        /* --- ÂêàË®àË°®Á§∫„ÅÆËá™ÂãïË™øÊï¥ --- */
        .total-val-box {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            text-align: right;
            color: #fff;
            font-weight: bold;
            font-family: monospace;
            font-size: 0.9em;
            padding: 4px;
            height: 1.8em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            letter-spacing: -0.5px;
            overflow: hidden;
            white-space: nowrap;
        }

        .total-label {
            text-align: center;
            font-weight: bold;
            color: #fff;
            font-size: 1.0em;
        }

        /* --- ToDo„É™„Çπ„Éà„Çπ„Çø„Ç§„É´ --- */
        .todo-edit-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #333;
        }

        .todo-edit-item:last-child {
            border-bottom: none;
        }

        .todo-check-wrapper {
            width: 22px;
            height: 22px;
            position: relative;
        }

        .todo-check-wrapper input {
            opacity: 0;
            width: 100%;
            height: 100%;
            position: absolute;
            cursor: pointer;
            z-index: 2;
        }

        .todo-checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 22px;
            height: 22px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .todo-check-wrapper input:checked~.todo-checkmark {
            background: #2e7d32;
            border-color: #4caf50;
        }

        .todo-check-wrapper input:checked~.todo-checkmark::after {
            content: '‚úî';
            color: #fff;
            font-size: 14px;
            position: absolute;
            left: 4px;
            top: 0;
        }

        .todo-input {
            flex: 1;
            background: #222;
            border: 1px solid #444;
            color: #eee;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 1em;
        }

        .todo-input.completed {
            text-decoration: line-through;
            color: #666;
        }

        #memo-editor,
        #todo-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 2000;
            padding-top: env(safe-area-inset-top);
            flex-direction: column;
        }

        #memo-editor.active,
        #todo-editor.active {
            display: flex;
        }

        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #202020;
            border-bottom: 1px solid #333;
        }

        input.edit-title-input {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            outline: none;
        }

        h2 {
            font-size: 1.1em;
            border-left: 6px solid #2e7d32;
            padding-left: 10px;
            margin: 15px 0 8px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-green {
            background: #2e7d32;
            color: #fff;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 8px 14px;
            font-size: 1em;
        }

        .btn-red {
            background: #c62828 !important;
            color: #fff !important;
            border: 1px solid #e57373;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .btn-backup {
            background: #1565c0;
            color: #fff;
            border: 1px solid #42a5f5;
            border-radius: 4px;
            padding: 12px;
            width: 100%;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .add-row-btn {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: #2e7d32;
            color: #fff;
            border: 1px solid #4caf50;
            border-radius: 4px;
            cursor: pointer;
        }

        .bg-green {
            background: #2e7d32;
            border: 1px solid #4caf50;
        }

        .bg-red {
            background: #c62828 !important;
            border: 1px solid #e57373;
        }

        .btn-toggle {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            width: 34px;
            height: 34px;
            font-weight: bold;
            font-size: 1.2em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        #sync-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #aaa;
            background: #222;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0.7;
            z-index: 9999;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color:#81c784; margin-bottom:30px;">ÂÆ∂Ë®àÁ∞ø</h1>
            <button class="login-btn" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">Google„Åß„É≠„Ç∞„Ç§„É≥
            </button>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div class="header-area">
            <div class="app-title-bar">ÂÆ∂Ë®àÁ∞ø</div>
            <div class="top-tabs">
                <div class="tab-item active" onclick="switchView('memo')" id="tab-memo">üìù „É°„É¢</div>
                <div class="tab-item" onclick="switchView('kakeibo')" id="tab-kakeibo">üí∞ ÂèéÊîØ</div>
                <div class="tab-item" onclick="switchView('todo')" id="tab-todo">‚úÖ ToDo</div>
                <div class="tab-item" onclick="switchView('fixed')" id="tab-fixed">üè¢ Âõ∫ÂÆöË≤ª</div>
                <div class="tab-item" onclick="switchView('save')" id="tab-save">üíæ ‰øùÂ≠ò</div>
            </div>
        </div>

        <div class="container">
            <!-- üìù „É°„É¢„Çø„Éñ -->
            <div id="view-memo" class="view-section active">
                <div id="memo-list-view">
                    <button class="add-row-btn" onclick="addNewMemo()">Ôºã Êñ∞„Åó„ÅÑ„É°„É¢„ÇíËøΩÂä†</button>
                    <div id="memo-list-container" style="margin-top:15px;"></div>
                </div>
                <div id="memo-editor">
                    <div class="editor-toolbar">
                        <button class="btn-green" onclick="closeMemoEditor()">Ôºú Êàª„Çã</button>
                        <button class="btn-red" onclick="deleteCurrentMemo()">ÂâäÈô§</button>
                    </div>
                    <input type="text" id="memo-edit-title" class="edit-title-input" placeholder="„Çø„Ç§„Éà„É´"
                        onblur="saveCurrentMemo()">
                    <textarea id="memo-edit-body" class="memo-body"
                        style="flex:1; width:100%; background:#272727; color:#f0f0f0; border:none; padding:15px; font-size:16px; font-family:monospace; resize:none; outline:none;"
                        placeholder="ÂÜÖÂÆπ„ÇíÂÖ•Âäõ..." onblur="saveCurrentMemo()"></textarea>
                </div>
            </div>

            <!-- üí∞ ÂèéÊîØ„Çø„Éñ -->
            <div id="view-kakeibo" class="view-section">
                <div id="year-ctrl"
                    style="background:#1f1f1f; padding:10px; margin-bottom:15px; border-radius:5px; border:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                    <select id="year-select" onchange="changeYear()"
                        style="font-size:1.2em; padding:5px; background:#333; color:#fff; border:1px solid #555;"></select>
                    <div>
                        <button class="btn-green" style="padding:6px 12px; font-size:0.9em;"
                            onclick="addNewYear()">ËøΩÂä†</button>
                        <button class="btn-red" style="padding:6px 12px; font-size:0.9em; margin-left:5px;"
                            onclick="deleteYear()">ÂâäÈô§</button>
                    </div>
                </div>
                <div id="month-tabs"
                    style="display:flex; overflow-x:auto; background:#000; margin-bottom:15px; border:1px solid #333; padding:5px 0;">
                </div>
                <h2 id="monthly-header-title">1Êúà„ÅÆÂèéÊîØ</h2>
                <div id="monthly-container"></div>
                <div style="text-align:center; margin-top:20px; border-top:1px dashed #444; padding-top:15px;">
                    <button class="add-row-btn" style="width:85%; padding:14px; margin:5px;"
                        onclick="addCategoryBlock('standard')">„É™„Çπ„Éà1„ÇíËøΩÂä†</button>
                    <button class="add-row-btn" style="width:85%; padding:14px; margin:5px;"
                        onclick="addCategoryBlock('detail')">„É™„Çπ„Éà2„ÇíËøΩÂä†</button>
                </div>
            </div>

            <!-- ‚úÖ ToDo„Çø„Éñ -->
            <div id="view-todo" class="view-section">
                <button class="add-row-btn" onclick="addNewTodo()">Ôºã Êñ∞„Åó„ÅÑToDo„ÇíËøΩÂä†</button>
                <div id="todo-list-container" style="margin-top:15px;"></div>
                <div id="todo-editor">
                    <div class="editor-toolbar">
                        <button class="btn-green" onclick="closeTodoEditor()">Ôºú Êàª„Çã</button>
                        <button class="btn-red" onclick="deleteCurrentTodo()">ÂâäÈô§</button>
                    </div>
                    <input type="text" id="todo-edit-title" class="edit-title-input" placeholder="ToDoÂêç"
                        onblur="saveCurrentTodo()">
                    <div style="flex:1; overflow-y:auto; padding:15px; background:#1a1a1a;">
                        <div id="todo-items-list"></div>
                        <button class="add-row-btn" onclick="addTodoItem()">Ôºã „Çø„Çπ„ÇØ„ÇíËøΩÂä†</button>
                    </div>
                </div>
            </div>

            <!-- üè¢ Âõ∫ÂÆöË≤ª„Çø„Éñ -->
            <div id="view-fixed" class="view-section">
                <h2>Âõ∫ÂÆöË≤ª</h2>
                <div style="background:#1e1e1e; padding:10px; border-radius:5px; border:1px solid #333;">
                    <div style="margin-bottom:20px;">
                        <div
                            style="font-weight:bold; color:#fff; border-bottom:2px solid #2e7d32; display:flex; justify-content:space-between; align-items:center;">
                            <span>Âπ¥Èñì</span><button class="btn-toggle" onclick="toggleFix('year')"
                                id="fix-btn-year">Ôºç</button>
                        </div>
                        <div id="fix-box-year">
                            <div id="fix-table-year"></div><button class="add-row-btn"
                                onclick="addFixItem('year')">ËøΩÂä†</button>
                        </div>
                    </div>
                    <div>
                        <div
                            style="font-weight:bold; color:#fff; border-bottom:2px solid #2e7d32; display:flex; justify-content:space-between; align-items:center;">
                            <span>ÊúàÈñì</span><button class="btn-toggle" onclick="toggleFix('month')"
                                id="fix-btn-month">Ôºç</button>
                        </div>
                        <div id="fix-box-month">
                            <div id="fix-table-month"></div><button class="add-row-btn"
                                onclick="addFixItem('month')">ËøΩÂä†</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- üíæ ‰øùÂ≠ò„Çø„Éñ -->
            <div id="view-save" class="view-section">
                <div style="padding:10px;">
                    <h2 style="border:none; justify-content:center;">„Éá„Éº„ÇøÁÆ°ÁêÜ</h2>
                    <button class="btn-backup" onclick="exportData()">üì§ „Éá„Éº„Çø„ÇíÊõ∏„ÅçÂá∫„Åó</button>
                    <textarea id="io-box" style="width:100%; height:120px; background:#2a2a2a; color:#fff;"
                        placeholder="„Åì„Åì„Å´„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶Âæ©ÂÖÉ"></textarea>
                    <button class="add-row-btn" style="background:#444; border:1px solid #666;"
                        onclick="importData()">üìÇ „Éá„Éº„Çø„ÇíÂæ©ÂÖÉ</button>
                    <button onclick="logout()"
                        style="width:100%; margin-top:40px; background:#444; color:#ccc; border:none; padding:10px; border-radius:4px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sync-status">ÂêåÊúüÂæÖÊ©ü‰∏≠...</div>

    <script>
        // FirebaseÂàùÊúüÂåñ (V8.11„É≠„Ç∏„ÉÉ„ÇØÂÆåÂÖ®Á∂≠ÊåÅ)
        const firebaseConfig = { apiKey: "AIzaSyCT_VvEPzGCPRLLFnzQuwArsYn2JnUR_fg", authDomain: "kakeibo-app-92bb4.firebaseapp.com", databaseURL: "https://kakeibo-app-92bb4-default-rtdb.firebaseio.com", projectId: "kakeibo-app-92bb4", storageBucket: "kakeibo-app-92bb4.firebasestorage.app", messagingSenderId: "45651637804", appId: "1:45651637804:web:f30ba95891d28538a14389" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.database(); let dbRef = null;
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        const initialData = { currentYear: "2025", lastViewedTab: "memo", years: { "2025": createNewYear() }, freeMemos: [], todos: [] };
        let data = JSON.parse(JSON.stringify(initialData));
        let isDataLoaded = false; let editMid = null; let editTid = null;

        auth.onAuthStateChanged(user => {
            if (user) { dbRef = db.ref('kakeiboData'); init(); }
            else { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('main-app').style.display = 'none'; }
        });

        async function loginWithGoogle() { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider().setCustomParameters({ prompt: 'select_account' })); } catch (e) { alert(e); } }
        function logout() { if (confirm("„É≠„Ç∞„Ç¢„Ç¶„ÉàÔºü")) auth.signOut().then(() => location.reload()); }

        function init() {
            dbRef.on('value', snap => {
                const v = snap.val(); if (v) { data = v; if (!data.years) data = JSON.parse(JSON.stringify(initialData)); if (!data.todos) data.todos = []; }
                isDataLoaded = true;
                switchView(data.lastViewedTab || 'memo');
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                const s = document.getElementById('sync-status'); s.innerText = "‚óè ÂêåÊúüÂÆå‰∫Ü"; setTimeout(() => s.innerText = "", 2000);
            });
        }

        function save(syncAn = false) {
            if (!isDataLoaded || !dbRef) return;
            if (syncAn) {
                const cur = data.years[data.currentYear];
                Object.keys(data.years).forEach(y => { if (y !== data.currentYear) { data.years[y].annualYear = JSON.parse(JSON.stringify(cur.annualYear)); data.years[y].annualMonth = JSON.parse(JSON.stringify(cur.annualMonth)); } });
            }
            dbRef.set(data); localStorage.setItem('kakeibo_bak', JSON.stringify(data));
            document.getElementById('sync-status').innerText = "‚ñ≤ ÈÄÅ‰ø°‰∏≠...";
        }

        function createNewYear() {
            let ms = {}; for (let i = 1; i <= 12; i++) ms[i] = [{ type: "standard", title: "ÈÄöÂ∏≥", isOpen: true, items: [], balance: 0, deposit: 0 }, { type: "standard", title: "Ë≤°Â∏É", isOpen: true, items: [], balance: 0, deposit: 0 }, { type: "detail", title: "Á´∂È¶¨", isOpen: true, items: [] }];
            return { annualYear: [], annualMonth: [], isAYOpen: true, isAMOpen: true, activeMonth: 1, months: ms };
        }

        window.switchView = (v) => {
            data.lastViewedTab = v;
            ['memo', 'kakeibo', 'todo', 'fixed', 'save'].forEach(id => {
                const t = document.getElementById(`tab-${id}`), s = document.getElementById(`view-${id}`);
                if (t) t.classList.toggle('active', id === v); if (s) s.classList.toggle('active', id === v);
            });
            if (v === 'memo') renderM(); if (v === 'todo') renderT(); if (v === 'kakeibo' || v === 'fixed') renderK();
            if (v !== 'memo') document.getElementById('memo-editor').classList.remove('active');
            if (v !== 'todo') document.getElementById('todo-editor').classList.remove('active');
            save();
        };

        // --- „É°„É¢„É≠„Ç∏„ÉÉ„ÇØ ---
        function renderM() {
            const c = document.getElementById('memo-list-container'); c.innerHTML = '';
            data.freeMemos.forEach(m => {
                const d = document.createElement('div'); d.className = 'memo-card';
                d.innerHTML = `<div class="memo-card-header"><span class="memo-card-title">${m.title}</span><div class="memo-ctrl-btns">
                <button class="btn-edit-mode" onclick="openE('${m.id}')">‚úê Á∑®ÈõÜ</button>
                <button class="btn-icon" onclick="moveM('${m.id}')">‚ñ≤</button>
                <button class="btn-toggle-memo" onclick="togM('${m.id}')">${m.isOpen ? 'Ôºç' : 'Ôºã'}</button>
            </div></div><div class="memo-card-body ${m.isOpen ? '' : 'collapsed'}">${m.body}</div>`;
                c.appendChild(d);
            });
        }
        window.addNewMemo = () => { const id = Date.now().toString(); data.freeMemos.push({ id, title: "Êñ∞Ë¶è„É°„É¢", body: "", isOpen: true }); save(); openE(id); };
        window.openE = id => { editMid = id; const m = data.freeMemos.find(x => x.id === id); document.getElementById('memo-list-view').classList.add('hidden'); document.getElementById('memo-editor').classList.add('active'); document.getElementById('memo-edit-title').value = m.title; document.getElementById('memo-edit-body').value = m.body; };
        window.closeMemoEditor = () => { saveE(); editMid = null; document.getElementById('memo-editor').classList.remove('active'); document.getElementById('memo-list-view').classList.remove('hidden'); renderM(); };
        window.saveE = () => { if (!editMid) return; const m = data.freeMemos.find(x => x.id === editMid); m.title = document.getElementById('memo-edit-title').value; m.body = document.getElementById('memo-edit-body').value; save(); };
        window.deleteCurrentMemo = () => { if (confirm("Ê∂à„ÅôÔºü")) { data.freeMemos = data.freeMemos.filter(x => x.id !== editMid); save(); closeMemoEditor(); } };
        window.moveM = id => { const i = data.freeMemos.findIndex(x => x.id === id); if (i > 0) [data.freeMemos[i], data.freeMemos[i - 1]] = [data.freeMemos[i - 1], data.freeMemos[i]]; save(); renderM(); };
        window.togM = id => { const m = data.freeMemos.find(x => x.id === id); m.isOpen = !m.isOpen; save(); renderM(); };

        // --- ToDo„É≠„Ç∏„ÉÉ„ÇØ (ÈÄöÂ∏∏Ë°®Á§∫: „Çø„Ç§„Éà„É´+2Ë°å / Âè≥„Éú„Çø„É≥) ---
        function renderT() {
            const c = document.getElementById('todo-list-container'); c.innerHTML = '';
            data.todos.forEach(t => {
                const d = document.createElement('div'); d.className = 'memo-card';
                const lines = (t.items || []).slice(0, 2).map(i => `<div style="font-size:0.9em; ${i.done ? 'text-decoration:line-through;color:#888' : ''}">${i.done ? '‚òë' : '‚òê'} ${i.text}</div>`).join('');
                d.innerHTML = `<div class="memo-card-header"><span class="memo-card-title">${t.title}</span><div class="memo-ctrl-btns">
                <button class="btn-edit-mode" onclick="openTE('${t.id}')">‚úê Á∑®ÈõÜ</button>
                <button class="btn-icon" onclick="moveT('${t.id}')">‚ñ≤</button>
                <button class="btn-toggle-memo" onclick="togT('${t.id}')">${t.isOpen ? 'Ôºç' : 'Ôºã'}</button>
            </div></div><div class="memo-card-body ${t.isOpen ? '' : 'collapsed'}">${lines || '„Çø„Çπ„ÇØ„Å™„Åó'}</div>`;
                c.appendChild(d);
            });
        }
        window.addNewTodo = () => { const id = Date.now().toString(); data.todos.push({ id, title: "Êñ∞Ë¶èToDo", items: [], isOpen: true }); save(); openTE(id); };
        window.openTE = id => { editTid = id; const t = data.todos.find(x => x.id === id); document.getElementById('todo-editor').classList.add('active'); document.getElementById('todo-edit-title').value = t.title; renderTI(); };
        window.closeTodoEditor = () => { saveTE(); editTid = null; document.getElementById('todo-editor').classList.remove('active'); renderT(); };
        window.saveTE = () => { if (!editTid) return; const t = data.todos.find(x => x.id === editTid); t.title = document.getElementById('todo-edit-title').value; save(); };
        function renderTI() {
            const c = document.getElementById('todo-items-list'); c.innerHTML = '';
            const t = data.todos.find(x => x.id === editTid);
            (t.items || []).forEach((item, idx) => {
                const d = document.createElement('div'); d.className = 'todo-edit-item';
                d.innerHTML = `<div class="todo-check-wrapper"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="togTI(${idx})"><div class="todo-checkmark" onclick="this.previousElementSibling.click()"></div></div>
            <input type="text" class="todo-input ${item.done ? 'completed' : ''}" value="${item.text}" onblur="editTI(${idx}, this.value)">
            <button class="mini-btn btn-del" onclick="delTI(${idx})">√ó</button>`;
                c.appendChild(d);
            });
        }
        window.addTodoItem = () => { const t = data.todos.find(x => x.id === editTid); if (!t.items) t.items = []; t.items.push({ text: "", done: false }); renderTI(); };
        window.togTI = idx => { const t = data.todos.find(x => x.id === editTid); t.items[idx].done = !t.items[idx].done; save(); renderTI(); };
        window.editTI = (idx, v) => { const t = data.todos.find(x => x.id === editTid); t.items[idx].text = v; save(); };
        window.delTI = idx => { const t = data.todos.find(x => x.id === editTid); t.items.splice(idx, 1); save(); renderTI(); };
        window.deleteCurrentTodo = () => { if (confirm("Ê∂à„ÅôÔºü")) { data.todos = data.todos.filter(x => x.id !== editTid); save(); closeTodoEditor(); } };
        window.moveT = id => { const i = data.todos.findIndex(x => x.id === id); if (i > 0) [data.todos[i], data.todos[i - 1]] = [data.todos[i - 1], data.todos[i]]; save(); renderT(); };
        window.togT = id => { const t = data.todos.find(x => x.id === id); t.isOpen = !t.isOpen; save(); renderT(); };

        // --- ÂèéÊîØ„É≠„Ç∏„ÉÉ„ÇØ ---
        function renderK() {
            const ys = document.getElementById('year-select'); ys.innerHTML = '';
            Object.keys(data.years).sort().forEach(y => { const o = document.createElement('option'); o.value = y; o.innerText = y + "Âπ¥"; if (y === data.currentYear) o.selected = true; ys.appendChild(o); });
            const yd = data.years[data.currentYear]; const am = yd.activeMonth || 1;
            document.getElementById('fix-btn-year').innerText = yd.isAYOpen ? 'Ôºç' : 'Ôºã'; document.getElementById('fix-box-year').classList.toggle('hidden', !yd.isAYOpen);
            document.getElementById('fix-btn-month').innerText = yd.isAMOpen ? 'Ôºç' : 'Ôºã'; document.getElementById('fix-box-month').classList.toggle('hidden', !yd.isAMOpen);
            renderTable('fix-table-year', yd.annualYear, 'annualYear'); renderTable('fix-table-month', yd.annualMonth, 'annualMonth');
            const ts = document.getElementById('month-tabs'); ts.innerHTML = '';
            for (let i = 1; i <= 12; i++) { const d = document.createElement('div'); d.className = `month-btn ${am === i ? 'active' : ''}`; d.innerText = i + "Êúà"; d.style = "padding:12px 18px;color:#888;border-right:1px solid #222;cursor:pointer"; if (am === i) d.style.background = "#2e7d32", d.style.color = "#fff", d.style.fontWeight = "bold", d.style.border = "1px solid #fff"; d.onclick = () => { yd.activeMonth = i; save(); renderK(); }; ts.appendChild(d); }
            document.getElementById('monthly-header-title').innerText = `${am}Êúà„ÅÆÂèéÊîØ`; renderB(yd, am);
        }
        function renderTable(cid, list, key) {
            const c = document.getElementById(cid); c.innerHTML = ''; const t = document.createElement('table');
            t.innerHTML = `<thead><tr><th class="col-date"></th><th>ÂêçÁß∞</th><th class="col-money">ÈáëÈ°ç</th><th class="col-btn"></th></tr></thead>`;
            const tb = document.createElement('tbody');
            (list || []).forEach((it, idx) => {
                const tr = document.createElement('tr');
                const tdD = document.createElement('td'); tdD.appendChild(createI(it.date, v => { data.years[data.currentYear][key][idx].date = v; save(true); }, key === 'annualYear' ? 'date' : 'day'));
                const tdT = document.createElement('td'); tdT.appendChild(createT(it.text, v => { data.years[data.currentYear][key][idx].text = v; save(true); }));
                const tdC = document.createElement('td'); tdC.appendChild(createM(it.cost, v => { data.years[data.currentYear][key][idx].cost = v; save(true); }));
                const tdCtl = document.createElement('td'); tdCtl.innerHTML = `<div class="ctrl-container">${idx > 0 ? `<button class="mini-btn btn-up" onclick="moveA('${key}',${idx})">‚ñ≤</button>` : ''}<button class="mini-btn btn-del" onclick="delA('${key}',${idx})">√ó</button></div>`;
                tr.append(tdD, tdT, tdC, tdCtl); tb.appendChild(tr);
            });
            t.appendChild(tb); c.appendChild(t);
        }
        function renderB(yd, m) {
            const c = document.getElementById('monthly-container'); c.innerHTML = '';
            (yd.months[m] || []).forEach((b, bi) => {
                const d = document.createElement('div'); d.className = 'category-block'; d.style = "background:#1e1e1e;padding:10px;margin-bottom:20px;border-radius:5px;border:1px solid #333";
                d.innerHTML = `<div class="cat-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><input type="text" class="cat-title-input" value="${b.title}" onchange="data.years[data.currentYear].months[${m}][${bi}].title=this.value;save()" style="width:120px;font-weight:bold;color:#fff;"><div style="display:flex;gap:5px;"><button class="mini-btn btn-del" style="width:40px" onclick="delB(${bi},${m})">ÂâäÈô§</button><button class="btn-toggle" onclick="togB(${bi},${m})">${b.isOpen ? 'Ôºç' : 'Ôºã'}</button></div></div>`;
                if (b.isOpen) {
                    const inner = document.createElement('div');
                    if (b.type === 'standard') {
                        inner.innerHTML = `<div class="summary-area" style="display:flex;gap:10px;margin-bottom:10px;background:#2a2a2a;padding:5px;border-radius:4px;"><div style="flex:1"><span style="font-size:0.8em;color:#aaa;">ÊÆãÈ´ò</span><div id="bal-${bi}"></div></div><div style="flex:1"><span style="font-size:0.8em;color:#aaa;">ËøΩÂä†</span><div id="dep-${bi}"></div></div></div>`;
                        inner.querySelector(`#bal-${bi}`).appendChild(createM(b.balance, v => { data.years[data.currentYear].months[m][bi].balance = v; save(); }, null, true));
                        inner.querySelector(`#dep-${bi}`).appendChild(createM(b.deposit, v => { data.years[data.currentYear].months[m][bi].deposit = v; save(); }, null, true));
                    }
                    const t = document.createElement('table');
                    t.innerHTML = b.type === 'standard' ? `<thead><tr><th class="col-date"></th><th>ÂÜÖÂÆπ</th><th class="col-money">‰∫àÂÆö</th><th class="col-money">Á¢∫ÂÆö</th><th class="col-btn"></th></tr></thead>` : `<thead><tr><th class="col-date"></th><th>ÂêçÁß∞</th><th class="col-money">ÂÖ•Èáë</th><th class="col-money">ÊâïÊàª</th><th class="col-btn"></th></tr></thead>`;
                    const tb = document.createElement('tbody');
                    (b.items || []).forEach((it, ii) => {
                        const tr = document.createElement('tr');
                        tr.appendChild(createTd(createI(it.date, v => { data.years[data.currentYear].months[m][bi].items[ii].date = v; save(); }, 'date')));
                        tr.appendChild(createTd(createT(it.name || it.text, v => { if (b.type === 'standard') data.years[data.currentYear].months[m][bi].items[ii].name = v; else data.years[data.currentYear].months[m][bi].items[ii].text = v; save(); }), '1'));
                        if (b.type === 'standard') {
                            tr.appendChild(createMtd(it.plan, v => { data.years[data.currentYear].months[m][bi].items[ii].plan = v; save(); }, bi, m));
                            tr.appendChild(createMtd(it.act, v => { data.years[data.currentYear].months[m][bi].items[ii].act = v; save(); }, bi, m));
                        } else {
                            tr.appendChild(createMtd(it.out, v => { data.years[data.currentYear].months[m][bi].items[ii].out = v; save(); }, bi, m));
                            tr.appendChild(createMtd(it.in, v => { data.years[data.currentYear].months[m][bi].items[ii].in = v; save(); }, bi, m));
                        }
                        const tdCtl = document.createElement('td'); tdCtl.innerHTML = `<div class="ctrl-container">${ii > 0 ? `<button class="mini-btn btn-up" onclick="moveI(${bi},${ii},${m})">‚ñ≤</button>` : ''}<button class="mini-btn btn-del" onclick="delI(${bi},${ii},${m})">√ó</button></div>`;
                        tr.append(tdCtl); tb.appendChild(tr);
                    });
                    const totalTr = document.createElement('tr'); totalTr.className = 'total-row';
                    totalTr.innerHTML = `<td></td><td class="total-label">ÂêàË®à</td><td><div class="total-val-box" id="t1-${bi}">0</div></td><td><div class="total-val-box" id="t2-${bi}">0</div></td><td></td>`;
                    tb.appendChild(totalTr); t.appendChild(tb); inner.appendChild(t); const addB = document.createElement('button'); addB.className = 'add-row-btn'; addB.innerText = 'ËøΩÂä†'; addB.onclick = () => addI(bi, m); inner.appendChild(addB); d.appendChild(inner);
                    setTimeout(() => updT(bi, m), 0);
                }
                c.appendChild(d);
            });
        }

        function createTd(el) { const td = document.createElement('td'); td.appendChild(el); return td; }
        function createMtd(v, cb, bi, m) { const td = document.createElement('td'); td.appendChild(createM(v, cb, () => updT(bi, m))); return td; }
        function updT(bi, m) {
            const b = data.years[data.currentYear].months[m][bi]; let s1 = 0, s2 = 0;
            (b.items || []).forEach(it => { if (b.type === 'standard') { s1 += Number(it.plan || 0); s2 += Number(it.act || 0); } else { s1 += Number(it.out || 0); s2 += Number(it.in || 0); } });
            const e1 = document.getElementById(`t1-${bi}`), e2 = document.getElementById(`t2-${bi}`);
            if (e1) { e1.innerText = fmt(s1); e1.style.fontSize = s1.toString().length > 10 ? '0.75em' : '0.9em'; }
            if (e2) { e2.innerText = fmt(s2); e2.style.fontSize = s2.toString().length > 10 ? '0.75em' : '0.9em'; }
        }
        function createI(v, cb, type) {
            const i = document.createElement('input'); i.value = v || "";
            if (type === 'date') { i.className = "date-input"; i.onblur = function () { this.value = fmtD(this.value); cb(this.value); }; }
            else { i.type = "tel"; i.className = "day-input"; i.oninput = function () { this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2); }; i.onblur = function () { cb(this.value); }; }
            return i;
        }
        function createT(v, cb) {
            const t = document.createElement('textarea'); t.className = "kakeibo-text"; t.value = v || ""; t.rows = 1;
            t.oninput = function () { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; };
            t.onblur = function () { cb(this.value); }; setTimeout(() => t.oninput(), 0); return t;
        }
        function createM(v, cb, bCb, isB) {
            const i = document.createElement('input'); i.type = "tel"; i.className = isB ? "summary-input" : "money-input";
            i.value = (v === 0 || v === "0") ? "" : Number(v).toLocaleString(); i.onfocus = function () { this.value = this.value.replace(/,/g, ''); this.select(); };
            i.onblur = function () { let n = parseInt(this.value.replace(/[^0-9\-]/g, '')) || 0; cb(n); this.value = n ? n.toLocaleString() : ""; if (bCb) bCb(); }; return i;
        }
        function fmtD(v) {
            let n = v.replace(/[^0-9]/g, ''); if (n.length === 4) return parseInt(n.slice(0, 2)) + "/" + parseInt(n.slice(2, 4));
            if (n.length === 3) { let m = parseInt(n.slice(0, 2)); if (m >= 10 && m <= 12) return m + "/" + parseInt(n.slice(2, 3)); else return parseInt(n.slice(0, 1)) + "/" + parseInt(n.slice(1, 3)); }
            return v;
        }
        function fmt(n) { return Number(n).toLocaleString(); }

        window.addFixItem = k => { data.years[data.currentYear][k === 'year' ? 'annualYear' : 'annualMonth'].push({ date: "", text: "", cost: 0 }); save(true); renderK(); };
        window.moveA = (k, idx) => { const l = data.years[data.currentYear][k]; if (idx > 0) [l[idx], l[idx - 1]] = [l[idx - 1], l[idx]]; save(true); renderK(); };
        window.delA = (k, idx) => { if (confirm("Ê∂à„ÅôÔºü")) { data.years[data.currentYear][k].splice(idx, 1); save(true); renderK(); } };
        window.toggleFix = t => { if (t === 'year') data.years[data.currentYear].isAYOpen = !data.years[data.currentYear].isAYOpen; else data.years[data.currentYear].isAMOpen = !data.years[data.currentYear].isAMOpen; save(); renderK(); };
        window.togB = (bi, m) => { data.years[data.currentYear].months[m][bi].isOpen = !data.years[data.currentYear].months[m][bi].isOpen; save(); renderK(); };
        window.addCategoryBlock = t => { const yd = data.years[data.currentYear]; yd.months[yd.activeMonth].push({ type: t, title: t === 'standard' ? '„É™„Çπ„Éà1' : '„É™„Çπ„Éà2', isOpen: true, items: [], balance: 0, deposit: 0 }); save(); renderK(); };
        window.delB = (bi, m) => { if (confirm("Ê∂à„ÅôÔºü")) { data.years[data.currentYear].months[m].splice(bi, 1); save(); renderK(); } };
        window.addI = (bi, m) => { const b = data.years[data.currentYear].months[m][bi]; b.items.push(b.type === 'standard' ? { date: "", name: "", plan: 0, act: 0 } : { date: "", name: "", out: 0, in: 0 }); save(); renderK(); };
        window.moveI = (bi, ii, m) => { const l = data.years[data.currentYear].months[m][bi].items; if (ii > 0) [l[ii], l[ii - 1]] = [l[ii - 1], l[ii]]; save(); renderK(); };
        window.delI = (bi, ii, m) => { if (confirm("Ê∂à„ÅôÔºü")) { data.years[data.currentYear].months[m][bi].items.splice(ii, 1); save(); renderK(); } };
        window.changeYear = () => { data.currentYear = document.getElementById('year-select').value; renderK(); };
        window.addNewYear = () => { let n = prompt("Ë•øÊö¶Ôºü"); if (n && !data.years[n]) { data.years[n] = createNewYear(); data.currentYear = n; save(); renderK(); } };
        window.deleteYear = () => { if (Object.keys(data.years).length > 1 && confirm("Ê∂à„ÅôÔºü")) { delete data.years[data.currentYear]; data.currentYear = Object.keys(data.years)[0]; save(); renderK(); } };

        window.exportData = () => { document.getElementById('io-box').value = JSON.stringify(data); alert("Âá∫ÂäõÂÆå‰∫Ü"); };
        window.importData = () => { try { const s = document.getElementById('io-box').value; if (s) { data = JSON.parse(s); save(); location.reload(); } } catch (e) { alert("„Ç®„É©„Éº"); } };
    </script>
</body>

</html>