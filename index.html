<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>å®¶è¨ˆç°¿</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
    /* ----------------------------------------------------
        ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« (V8.05 èª¿æ•´ç‰ˆ)
       ---------------------------------------------------- */
    body { 
        font-family: sans-serif; margin: 0; padding: 0; 
        background: #121212; color: #e0e0e0; 
        padding-bottom: 50px; 
        padding-top: calc(90px + env(safe-area-inset-top)); 
        user-select: none;
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    #login-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #121212; z-index: 3000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .login-box { text-align: center; }
    .login-btn {
        background: #fff; color: #000; border: none; padding: 12px 24px;
        border-radius: 25px; font-weight: bold; font-size: 1.1em;
        cursor: pointer; display: flex; align-items: center; gap: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼†ã‚¿ãƒ– --- */
    .header-area {
        position: fixed; top: 0; left: 0; width: 100%;
        background: #1b5e20; z-index: 1000;
        padding-top: env(safe-area-inset-top);
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }
    .app-title-bar {
        height: 30px; display: flex; align-items: center; justify-content: center;
        font-weight: bold; color: #81c784; font-size: 0.9em;
    }
    .top-tabs {
        display: flex; width: 100%; height: 50px;
        background: #1b5e20;
    }
    .tab-item {
        flex: 1; display: flex; align-items: center; justify-content: center;
        color: #a5d6a7; font-weight: bold; cursor: pointer;
        border-bottom: 4px solid transparent;
        transition: all 0.2s; font-size: 1.05em;
    }
    .tab-item.active {
        color: #fff; border-bottom: 4px solid #fff;
        background: rgba(255,255,255,0.1);
    }

    .container { padding: 10px; max-width: 600px; margin: 0 auto; }
    .view-section { display: none; animation: fadeIn 0.2s ease; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    table { width: 100%; border-collapse: separate; border-spacing: 0 4px; table-layout: fixed; font-size: 0.95em; }
    th { color: #aaa; font-weight: normal; font-size: 0.85em; text-align: center; padding-bottom: 2px; }
    td { vertical-align: top; padding: 0 1px; }
    .col-date { width: 54px; } .col-money { width: 70px; } .col-btn { width: 28px; }
    
    input, textarea { box-sizing: border-box; border: 1px solid #444; background: #2a2a2a; border-radius: 3px; color: #fff; font-size: 1.1em; padding: 2px; }
    textarea.kakeibo-text { width: 100%; color: #eee; resize: none; line-height: 1.4em; min-height: 2.2em; white-space: pre-wrap; word-break: break-all; overflow: hidden; vertical-align: middle; padding: 4px 2px; }
    input { height: 2.2em; }
    input.day-input { text-align: center; width: 100%; font-family: monospace; font-weight: bold; }
    input.money-input { text-align: right; color: #80d8ff; width: 100%; font-family: monospace; font-weight: bold; letter-spacing: -0.5px; padding-right: 2px; font-size: 1.0em; }
    
    .mini-btn { width: 100%; height: 2.2em; display: flex; align-items: center; justify-content: center; font-size: 1.0em; cursor: pointer; border: 1px solid #555; border-radius: 3px; }
    .btn-up { background: #333; color: #81c784; font-weight: bold; }
    .btn-del { background: #333; color: #e57373; font-weight: bold; }

    /* --- ãƒ¡ãƒ¢å¸³ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .memo-card { background: #202020; border: 1px solid #333; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    .memo-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .memo-card-title { font-weight: bold; color: #81c784; font-size: 1.2em; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 8px; }
    .memo-ctrl-btns { display: flex; gap: 5px; align-items: center; }
    .btn-edit-mode { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 0 12px; height: 32px; font-size: 0.9em; cursor: pointer; }
    .btn-icon { background: #333; color: #aaa; border: 1px solid #555; border-radius: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
    .btn-toggle-memo { background: #1b5e20; color: #fff; border: 1px solid #4caf50; border-radius: 4px; width: 32px; height: 32px; font-weight: bold; font-size: 1.2em; display: flex; align-items: center; justify-content: center; }
    .memo-card-body { font-family: 'Consolas', 'Monaco', monospace; color: #e0e0e0; font-size: 1.05em; line-height: 1.5; white-space: pre-wrap; word-break: break-all; border-top: 1px dashed #444; margin-top: 8px; padding-top: 8px; }
    .memo-card-body.collapsed { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: #888; border-top: none; }

    #memo-editor { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 2000; padding-top: env(safe-area-inset-top); flex-direction: column; }
    #memo-editor.active { display: flex; }
    .editor-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #202020; border-bottom: 1px solid #333; }
    input.memo-title-input { width: 100%; background: transparent; border: none; color: #fff; font-size: 1.2em; font-weight: bold; padding: 10px 15px; border-bottom: 1px solid #333; outline: none; }
    textarea.memo-body { flex: 1; width: 100%; background: #272727; color: #f0f0f0; border: none; padding: 15px; font-size: 16px; line-height: 1.6; font-family: 'Consolas', 'Monaco', monospace; resize: none; outline: none; box-sizing: border-box; }

    /* --- ãã®ä»– --- */
    h2 { font-size: 1.2em; border-left: 6px solid #2e7d32; padding-left: 10px; margin: 20px 0 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }
    .btn-green { background: #2e7d32; color: #fff; border: 1px solid #4caf50; border-radius: 4px; padding: 8px 14px; font-size: 1em; }
    .btn-red { background: #c62828; color: #fff; border: 1px solid #e57373; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; }
    .btn-backup { background: #1565c0; color: #fff; border: 1px solid #42a5f5; border-radius: 4px; padding: 12px; font-size: 1.1em; width: 100%; margin-bottom: 15px; cursor: pointer; }
    .btn-backup-sub { background: #424242; color: #ccc; border: 1px solid #666; border-radius: 4px; padding: 12px; font-size: 1.1em; width: 100%; margin-bottom: 15px; }
    .add-row-btn { width: 100%; padding: 10px; margin-top: 5px; background: #2e7d32; color: #fff; border: 1px solid #4caf50; border-radius: 4px; font-size: 1.1em; }
    input.summary-input { text-align: right; color: #80d8ff; width: 120px; height: 2.5em; font-family: monospace; font-weight: bold; background: #333; border: 1px solid #555; border-radius: 4px; font-size: 1.3em; padding-right: 6px; }
    #annual-section { background: #1e1e1e; padding: 10px; border-radius: 5px; border: 1px solid #333; }
    .annual-group { margin-bottom: 30px; }
    .annual-header { font-weight: bold; color: #fff; border-bottom: 2px solid #2e7d32; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .year-controls { background: #1f1f1f; padding: 10px; margin: 15px 0; border-radius: 5px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .month-selector { display: flex; overflow-x: auto; background: #000; margin-bottom: 15px; border: 1px solid #333; padding: 5px 0; }
    .month-btn { flex: 0 0 auto; padding: 12px 18px; color: #888; border-right: 1px solid #222; }
    .month-btn.active { background: #2e7d32; color: #fff; font-weight: bold; border: 1px solid #fff; border-radius: 2px; }
    .category-block { background: #1e1e1e; padding: 10px; margin-bottom: 25px; border-radius: 5px; border: 1px solid #333; }
    .cat-header { display: flex; justify-content: space-between; align-items: center; background: #2c2c2c; padding: 8px; border-radius: 3px; border: 1px solid #444; }
    .cat-title-input { font-weight: bold; border: none !important; background: transparent !important; font-size: 1.4em; width: 60%; color: #fff; }
    .summary-area { display: flex; align-items: center; justify-content: space-around; background: #252525; padding: 10px 5px; margin-bottom: 10px; border: 1px solid #383838; }
    .total-val-box { background: #2a2a2a; border: 1px solid #444; border-radius: 3px; text-align: right; color: #fff; font-weight: bold; font-family: monospace; font-size: 1.05em; padding: 4px; display: flex; align-items: center; justify-content: flex-end; }
    #sync-status { position:fixed; bottom:10px; right:10px; font-size:0.8em; color:#aaa; background:#222; padding:4px 8px; border-radius:4px; opacity:0.7; z-index:9999; }
    .hidden { display: none; }
</style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h1 style="color:#81c784; margin-bottom:30px;">å®¶è¨ˆç°¿</h1>
        <button class="login-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Googleã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div class="header-area">
        <div class="app-title-bar">å®¶è¨ˆç°¿ (V8.05)</div>
        <div class="top-tabs">
            <div class="tab-item" onclick="switchView('memo')" id="tab-memo">ğŸ“ ãƒ¡ãƒ¢</div>
            <div class="tab-item" onclick="switchView('fixed')" id="tab-fixed">ğŸ¢ å›ºå®šè²»</div>
            <div class="tab-item active" onclick="switchView('kakeibo')" id="tab-kakeibo">ğŸ’° åæ”¯</div>
            <div class="tab-item" onclick="switchView('save')" id="tab-save">ğŸ’¾ ä¿å­˜</div>
        </div>
    </div>

    <div class="container">
        <div id="view-memo" class="view-section">
            <div id="memo-list-view">
                <button class="add-row-btn" onclick="addNewMemo()">ï¼‹ æ–°ã—ã„ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
                <div id="memo-list-container" style="margin-top:15px;"></div>
            </div>
            <div id="memo-editor">
                <div class="editor-toolbar">
                    <button class="btn-green" onclick="closeMemoEditor()">ï¼œ æˆ»ã‚‹</button>
                    <button class="btn-red" onclick="deleteCurrentMemo()">å‰Šé™¤</button>
                </div>
                <input type="text" id="memo-edit-title" class="memo-title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" onblur="saveCurrentMemo()">
                <textarea id="memo-edit-body" class="memo-body" placeholder="å†…å®¹ã‚’å…¥åŠ›..." onblur="saveCurrentMemo()"></textarea>
            </div>
        </div>

        <div id="view-fixed" class="view-section">
            <h2>å›ºå®šè²»</h2>
            <div id="annual-section">
                <div class="annual-group">
                    <div class="annual-header"><span>å¹´é–“</span><button class="btn-toggle" onclick="toggleAnnualSub('year')" id="btn-annual-year">ï¼</button></div>
                    <div id="content-annual-year"><div id="annual-table-year"></div><button class="add-row-btn" onclick="addAnnualItem('year')">è¿½åŠ </button></div>
                </div>
                <div class="annual-group">
                    <div class="annual-header"><span>æœˆé–“</span><button class="btn-toggle" onclick="toggleAnnualSub('month')" id="btn-annual-month">ï¼</button></div>
                    <div id="content-annual-month"><div id="annual-table-month"></div><button class="add-row-btn" onclick="addAnnualItem('month')">è¿½åŠ </button></div>
                </div>
            </div>
        </div>

        <div id="view-kakeibo" class="view-section active">
            <div class="year-controls">
                <select id="year-select" onchange="changeYear()"></select>
                <div>
                    <button class="btn-year-ctrl btn-green" onclick="addNewYear()">è¿½åŠ </button>
                    <button class="btn-year-ctrl btn-red" onclick="deleteYear()">å‰Šé™¤</button>
                </div>
            </div>
            <div class="month-selector" id="month-tabs"></div>
            <h2 id="monthly-header-title">1æœˆã®åæ”¯</h2> 
            <div id="monthly-container"></div>
            <div class="add-block-area" style="margin-top:20px; display:flex; gap:10px;">
                <button class="add-row-btn" style="flex:1;" onclick="addCategoryBlock('standard')">ãƒªã‚¹ãƒˆ1ã‚’è¿½åŠ </button>
                <button class="add-row-btn" style="flex:1;" onclick="addCategoryBlock('detail')">ãƒªã‚¹ãƒˆ2ã‚’è¿½åŠ </button>
            </div>
        </div>

        <div id="view-save" class="view-section">
            <div class="settings-menu">
                <h2 style="border:none; justify-content:center;">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <button class="btn-backup" onclick="shareDataText()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã— (å…±æœ‰)</button>
                <button class="btn-backup" style="background:#00695c; border-color:#00897b;" onclick="exportDataToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
                <hr style="border:0; border-top:1px solid #444; margin:20px 0;">
                <textarea id="backup-box" style="width:100%; height:100px; background:#2a2a2a; color:#fff;" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦å¾©å…ƒ"></textarea>
                <button class="btn-backup-sub" style="width:100%; padding:12px;" onclick="importDataFromText()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ (èª­ã¿è¾¼ã¿)</button>
                <button onclick="logout()" style="width:100%; margin-top:30px; background:#444; color:#ccc; border:none; padding:10px; cursor:pointer; border-radius:4px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="sync-status">åŒæœŸå¾…æ©Ÿä¸­...</div>

<script>
    // --- åˆæœŸè¨­å®š ---
    const VERSION = "kakeibo_V8.05";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCT_VvEPzGCPRLLFnzQuwArsYn2JnUR_fg",
        authDomain: "kakeibo-app-92bb4.firebaseapp.com",
        databaseURL: "https://kakeibo-app-92bb4-default-rtdb.firebaseio.com",
        projectId: "kakeibo-app-92bb4",
        storageBucket: "kakeibo-app-92bb4.firebasestorage.app",
        messagingSenderId: "45651637804",
        appId: "1:45651637804:web:f30ba95891d28538a14389"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let dbRef = null;

    const initialData = {
        currentYear: "2025",
        lastViewedTab: "kakeibo",
        years: { "2025": createNewYearData() },
        freeMemos: [] 
    };

    let data = JSON.parse(JSON.stringify(initialData));
    let isDataLoaded = false;
    let editingMemoId = null;

    // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithRedirect(provider);
    }

    function logout() {
        if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            auth.signOut().then(() => { location.reload(); });
        }
    }

    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
    auth.onAuthStateChanged((user) => {
        const loginScr = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        if (user) {
            loginScr.style.display = 'none';
            mainApp.style.display = 'block';
            dbRef = db.ref('kakeiboData');
            initApp();
        } else {
            loginScr.style.display = 'flex';
            mainApp.style.display = 'none';
        }
    });

    function initApp() {
        if(!dbRef) return;
        // ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
        dbRef.on('value', (snapshot) => {
            const val = snapshot.val();
            const statusEl = document.getElementById('sync-status');
            
            if (val) {
                data = val; 
                if(!data.years) data = JSON.parse(JSON.stringify(initialData));
                if(!data.freeMemos) data.freeMemos = [];
            } else {
                // DBãŒç©ºã®å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèª
                const local = localStorage.getItem('kakeiboDataV7_Backup');
                if(local) {
                    data = JSON.parse(local);
                } else {
                    data = JSON.parse(JSON.stringify(initialData));
                }
                saveData(false);
            }
            
            isDataLoaded = true;
            // åˆå›è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
            switchView(data.lastViewedTab || 'kakeibo');
            if(!document.getElementById('memo-editor').classList.contains('active')) {
                renderMemoList(); 
            }
            
            if(statusEl) {
                statusEl.innerText = "â— åŒæœŸå®Œäº†";
                setTimeout(() => { statusEl.innerText = ""; }, 2000);
            }
        }, (error) => {
            console.error("Database Error:", error);
            alert("ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firebaseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        });
    }

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ ---
    function saveData(syncAnnual = false) {
        if(!isDataLoaded || !dbRef) return;
        if(syncAnnual) {
            const currentY = data.years[data.currentYear];
            Object.keys(data.years).forEach(y => {
                if(y !== data.currentYear && data.years[y]) {
                    data.years[y].annualYear = JSON.parse(JSON.stringify(currentY.annualYear));
                    data.years[y].annualMonth = JSON.parse(JSON.stringify(currentY.annualMonth));
                    data.years[y].isAnnualYearOpen = currentY.isAnnualYearOpen;
                    data.years[y].isAnnualMonthOpen = currentY.isAnnualMonthOpen;
                }
            });
        }
        dbRef.set(data).catch(err => { console.error("Save Error:", err); });
        localStorage.setItem('kakeiboDataV7_Backup', JSON.stringify(data));
        const el = document.getElementById('sync-status');
        if(el) el.innerText = "â†‘ é€ä¿¡ä¸­...";
    }

    function createNewYearData() {
        let months = {};
        for(let i=1; i<=12; i++){
            months[i] = [
                { type: "standard", title: "é€šå¸³", isOpen: true, items: [], balance: 0, deposit: 0 },
                { type: "standard", title: "è²¡å¸ƒ", isOpen: true, items: [], balance: 0, deposit: 0 },
                { type: "detail", title: "ç«¶é¦¬", isOpen: true, items: [] }
            ];
        }
        return { annualYear: [], annualMonth: [], isAnnualYearOpen: true, isAnnualMonthOpen: true, activeMonth: 1, months: months };
    }

    window.switchView = (viewName) => {
        if(viewName !== 'memo') closeMemoEditor();
        ['memo','fixed','kakeibo','save'].forEach(v => {
            const tab = document.getElementById(`tab-${v}`);
            const sec = document.getElementById(`view-${v}`);
            if(tab) tab.classList.remove('active');
            if(sec) sec.classList.remove('active');
        });
        const activeTab = document.getElementById(`tab-${viewName}`);
        const activeSec = document.getElementById(`view-${viewName}`);
        if(activeTab) activeTab.classList.add('active');
        if(activeSec) activeSec.classList.add('active');
        data.lastViewedTab = viewName; 
        if(viewName === 'kakeibo' || viewName === 'fixed') renderKakeibo();
        if(viewName === 'memo') renderMemoList();
        if(isDataLoaded) saveData();
    };

    // --- ãƒ¡ãƒ¢æ©Ÿèƒ½ ---
    window.addNewMemo = () => { const id = Date.now().toString(); data.freeMemos.push({ id: id, title: "æ–°è¦ãƒ¡ãƒ¢", body: "", isOpen: true }); saveData(); openMemoEditor(id); };
    window.renderMemoList = () => {
        const container = document.getElementById('memo-list-container'); if(!container) return; container.innerHTML = '';
        data.freeMemos.forEach((memo) => {
            if(memo.isOpen === undefined) memo.isOpen = true; 
            const div = document.createElement('div'); div.className = 'memo-card';
            const header = document.createElement('div'); header.className = 'memo-card-header';
            const titleSpan = document.createElement('span'); titleSpan.className = 'memo-card-title'; titleSpan.innerText = memo.title;
            const btnGroup = document.createElement('div'); btnGroup.className = 'memo-ctrl-btns';
            const editBtn = document.createElement('button'); editBtn.className = 'btn-edit-mode'; editBtn.innerText = 'âœ ç·¨é›†';
            editBtn.onclick = (e) => { e.stopPropagation(); openMemoEditor(memo.id); };
            const upBtn = document.createElement('button'); upBtn.className = 'btn-icon'; upBtn.innerText = 'â†‘';
            upBtn.onclick = (e) => { e.stopPropagation(); moveMemo(memo.id, 'up'); };
            const toggleBtn = document.createElement('button'); toggleBtn.className = 'btn-toggle-memo'; toggleBtn.innerText = memo.isOpen ? 'ï¼' : 'ï¼‹';
            toggleBtn.onclick = (e) => { e.stopPropagation(); toggleMemo(memo.id); };
            btnGroup.append(editBtn, upBtn, toggleBtn); header.append(titleSpan, btnGroup);
            const body = document.createElement('div'); body.className = 'memo-card-body';
            if(!memo.isOpen) body.classList.add('collapsed');
            body.innerText = memo.body; div.append(header, body); container.appendChild(div);
        });
    };
    window.moveMemo = (id, direction) => {
        const index = data.freeMemos.findIndex(m => m.id === id);
        if (direction === 'up' && index > 0) [data.freeMemos[index], data.freeMemos[index - 1]] = [data.freeMemos[index - 1], data.freeMemos[index]];
        saveData(); renderMemoList();
    };
    window.toggleMemo = (id) => { const m = data.freeMemos.find(m => m.id === id); if(m) { m.isOpen = !m.isOpen; saveData(); renderMemoList(); } };
    window.openMemoEditor = (id) => {
        editingMemoId = id; const m = data.freeMemos.find(m => m.id === id); if(!m) return;
        document.getElementById('memo-list-view').style.display = 'none';
        document.getElementById('memo-editor').classList.add('active');
        document.getElementById('memo-edit-title').value = m.title;
        document.getElementById('memo-edit-body').value = m.body;
    };
    window.closeMemoEditor = () => { if(!editingMemoId) return; saveCurrentMemo(); editingMemoId = null; document.getElementById('memo-editor').classList.remove('active'); document.getElementById('memo-list-view').style.display = 'block'; renderMemoList(); };
    window.saveCurrentMemo = () => { if(!editingMemoId) return; const m = data.freeMemos.find(m => m.id === editingMemoId); if(m) { m.title = document.getElementById('memo-edit-title').value; m.body = document.getElementById('memo-edit-body').value; saveData(); } };
    window.deleteCurrentMemo = () => { if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return; data.freeMemos = data.freeMemos.filter(m => m.id !== editingMemoId); saveData(); editingMemoId = null; document.getElementById('memo-editor').classList.remove('active'); document.getElementById('memo-list-view').style.display = 'block'; renderMemoList(); };

    // --- å®¶è¨ˆç°¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    function renderKakeibo() {
        const yearSelect = document.getElementById('year-select'); if(!yearSelect) return; yearSelect.innerHTML = '';
        const sortedYears = Object.keys(data.years).sort();
        if(sortedYears.length===0){ data.years["2025"]=createNewYearData(); data.currentYear="2025"; sortedYears.push("2025"); }
        if(!data.years[data.currentYear]) data.currentYear=sortedYears[0];
        sortedYears.forEach(y=>{ const op=document.createElement('option'); op.value=y; op.innerText=y+"å¹´"; if(y===data.currentYear)op.selected=true; yearSelect.appendChild(op); });
        
        const yd = data.years[data.currentYear]; let activeMonth = yd.activeMonth || 1;
        document.getElementById('content-annual-year').className = yd.isAnnualYearOpen!==false ? '' : 'hidden'; document.getElementById('btn-annual-year').innerText = yd.isAnnualYearOpen!==false ? 'ï¼' : 'ï¼‹';
        document.getElementById('content-annual-month').className = yd.isAnnualMonthOpen!==false ? '' : 'hidden'; document.getElementById('btn-annual-month').innerText = yd.isAnnualMonthOpen!==false ? 'ï¼' : 'ï¼‹';
        
        renderAnnualTable('annual-table-year', yd.annualYear, 'annualYear'); renderAnnualTable('annual-table-month', yd.annualMonth, 'annualMonth');
        
        const tabs=document.getElementById('month-tabs'); tabs.innerHTML='';
        for(let i=1; i<=12; i++){ const d=document.createElement('div'); d.className=`month-btn ${activeMonth===i?'active':''}`; d.innerText=i+"æœˆ"; d.onclick=()=>{ yd.activeMonth = i; saveData(); renderKakeibo(); }; tabs.appendChild(d); }
        document.getElementById('monthly-header-title').innerText = `${activeMonth}æœˆã®åæ”¯`; renderMonthlyBlocks(yd, activeMonth);
    }

    function renderAnnualTable(cid, list, key) {
        const c=document.getElementById(cid); if(!c) return; c.innerHTML=''; const t=document.createElement('table');
        t.innerHTML=`<thead><tr><th class="col-date">æ—¥ä»˜</th><th>å†…å®¹</th><th class="col-money">é‡‘é¡</th><th class="col-btn"></th><th class="col-btn"></th></tr></thead>`;
        const tb=document.createElement('tbody'); (list||[]).forEach((item,idx)=>{
            const tr=document.createElement('tr'); const tdD=document.createElement('td'); 
            if(key==='annualYear') tdD.appendChild(createInp(item.date, v=>updAnn(key,idx,'date',v), 'date'));
            else { const w=document.createElement('div'); w.style.display="flex"; w.style.alignItems="center"; w.style.justifyContent="center"; w.append(createInp(item.date, v=>updAnn(key,idx,'date',v), 'day'), createSuf("æ—¥")); tdD.appendChild(w); }
            const tdTx=document.createElement('td'); tdTx.appendChild(createTxt(item.text, v=>updAnn(key,idx,'text',v)));
            const tdC=document.createElement('td'); tdC.appendChild(createMon(item.cost, v=>updAnn(key,idx,'cost',v)));
            const tdUp=document.createElement('td'); if(idx > 0) tdUp.innerHTML=`<button class="mini-btn btn-up" onclick="moveAnn('${key}',${idx},'up')">â†‘</button>`;
            const tdDel=document.createElement('td'); tdDel.innerHTML=`<button class="mini-btn btn-del" onclick="delAnn('${key}',${idx})">Ã—</button>`;
            tr.append(tdD,tdTx,tdC,tdUp,tdDel); tb.appendChild(tr); 
        }); t.appendChild(tb); c.appendChild(t);
    }

    function renderMonthlyBlocks(yd, month) {
        const c=document.getElementById('monthly-container'); if(!c) return; c.innerHTML='';
        (yd.months[month]||[]).forEach((b,bi)=>{
            const d=document.createElement('div'); d.className='category-block';
            d.innerHTML=`<div class="cat-header"><input type="text" class="cat-title-input" value="${b.title}" onchange="updBkTi(${bi},this.value,${month})"><div style="display:flex;align-items:center;"><button class="btn-red" onclick="delBk(${bi},${month})">å‰Šé™¤</button><button class="btn-toggle" style="background:#333;color:#fff;border:1px solid #555;border-radius:3px;margin-left:5px;width:30px;height:30px;" onclick="togBk(${bi},${month})">${b.isOpen!==false?'ï¼':'ï¼‹'}</button></div></div>`;
            const contentDiv = document.createElement('div'); if(b.isOpen===false) contentDiv.classList.add('hidden');
            if(b.type==='standard'){
                const summaryDiv = document.createElement('div'); summaryDiv.className = 'summary-area';
                summaryDiv.innerHTML = `<div class="summary-item"><div class="summary-label">æ®‹é«˜</div></div><div class="summary-item"><div class="summary-label">å…¥ã‚Œã‚‹é¡</div></div>`;
                summaryDiv.children[0].appendChild(createMon(b.balance, v=>updBkVal(bi, 'balance', v, month), null, true));
                summaryDiv.children[1].appendChild(createMon(b.deposit, v=>updBkVal(bi, 'deposit', v, month), null, true));
                contentDiv.appendChild(summaryDiv);
            }
            const t=document.createElement('table'); const tb=document.createElement('tbody');
            if(b.type==='standard') t.innerHTML=`<thead><tr><th class="col-date">æ—¥ä»˜</th><th>å†…å®¹</th><th class="col-money">äºˆå®š</th><th class="col-money">ç¢ºå®š</th><th class="col-btn"></th><th class="col-btn"></th></tr></thead>`;
            else t.innerHTML=`<thead><tr><th class="col-date">æ—¥ä»˜</th><th>é …ç›®</th><th class="col-money">å‡º</th><th class="col-money">å…¥</th><th class="col-btn"></th><th class="col-btn"></th></tr></thead>`;
            (b.items||[]).forEach((it,ii)=>{
                const tr=document.createElement('tr'); const tdD=document.createElement('td'); const w=document.createElement('div'); w.style.display="flex"; w.style.alignItems="center"; w.style.justifyContent="center";
                w.append(createInp(it.date, v=>updIt(bi,ii,'date',v,month), 'day'), createSuf("æ—¥")); tdD.appendChild(w);
                const tdN=document.createElement('td'); tdN.appendChild(createTxt(it.name, v=>updIt(bi,ii,'name',v,month))); tr.append(tdD, tdN);
                if(b.type==='standard'){ tr.append(createMonTd(it.plan, v=>updIt(bi,ii,'plan',v,month), bi, month), createMonTd(it.act, v=>updIt(bi,ii,'act',v,month), bi, month)); }
                else { tr.append(createMonTd(it.out, v=>updIt(bi,ii,'out',v,month), bi, month), createMonTd(it.in, v=>updIt(bi,ii,'in',v,month), bi, month)); }
                const tdUp=document.createElement('td'); if(ii > 0) tdUp.innerHTML=`<button class="mini-btn btn-up" onclick="moveIt(${bi},${ii},${month},'up')">â†‘</button>`;
                const tdDel=document.createElement('td'); tdDel.innerHTML=`<button class="mini-btn btn-del" onclick="delIt(${bi},${ii},${month})">Ã—</button>`;
                tr.append(tdUp, tdDel); tb.appendChild(tr); 
            });
            const trTotal = document.createElement('tr'); trTotal.className = 'total-row'; let s1=0, s2=0;
            if(b.type==='standard'){ (b.items||[]).forEach(i=>{s1+=Number(i.plan);s2+=Number(i.act)}); trTotal.innerHTML=`<td class="total-label">åˆè¨ˆ</td><td></td><td><div class="total-val-box">${formatNum(s1)}</div></td><td><div class="total-val-box">${formatNum(s2)}</div></td><td colspan="2"></td>`; }
            else { (b.items||[]).forEach(i=>{s1+=Number(i.out);s2+=Number(i.in)}); trTotal.innerHTML=`<td></td><td class="total-label">åˆè¨ˆ</td><td><div class="total-val-box">${formatNum(s1)}</div></td><td><div class="total-val-box">${formatNum(s2)}</div></td><td colspan="2"></td>`; }
            tb.appendChild(trTotal); t.appendChild(tb); contentDiv.append(t, createAddRowBtn(()=>addIt(bi, month))); d.appendChild(contentDiv); c.appendChild(d);
        });
    }

    // --- å„ç¨®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    function createMonTd(val, cb, bi, m) { const td = document.createElement('td'); td.appendChild(createMon(val, cb, ()=>updateTotalDisplay(bi,m))); return td; }
    function updateTotalDisplay(bIdx, month) { renderKakeibo(); }
    function createInp(val, cb, type) { const i=document.createElement('input'); i.value=val||""; if(type==='date') i.onblur=function(){this.value=formatDateAnnual(this.value); cb(this.value)}; else { i.type="tel"; i.className="day-input"; i.setAttribute("maxlength","2"); i.oninput=function(){let v=this.value.replace(/[^0-9]/g,'');if(Number(v)>31)v="31";this.value=v;}; i.onblur=function(){ cb(this.value); }; } return i; }
    function createTxt(v,cb){ const t=document.createElement('textarea'); t.className="kakeibo-text"; t.value=v||""; t.oninput=function(){this.style.height='auto';this.style.height=this.scrollHeight+'px';}; t.onblur=function(){cb(this.value);}; setTimeout(()=>t.oninput(),0); return t; }
    function createMon(v, cb, bCb, isBig = false){ const i=document.createElement('input'); i.type="tel"; i.className = isBig ? "summary-input" : "money-input"; i.value = v ? Number(v).toLocaleString() : ""; i.onfocus=function(){this.value=this.value.replace(/,/g,'');this.select();}; i.oninput=function(){let r=this.value.replace(/[^0-9\-]/g,'');if(r.lastIndexOf('-')>0)r=r.replace(/-/g,'');this.value=r;}; i.onblur=function(){let val=parseFloat(this.value.replace(/,/g,''));if(isNaN(val)||val===0){cb(0);this.value="";}else{let n=Math.max(-999999,Math.min(999999,val));cb(n);this.value=n.toLocaleString();}if(bCb) bCb();}; return i; }
    function createAddRowBtn(fn){ const b=document.createElement('button'); b.className='add-row-btn'; b.innerText='è¿½åŠ '; b.onclick=fn; return b; }
    function createSuf(t){const s=document.createElement('span');s.style.fontSize="0.8em";s.innerText=t;return s;}
    function formatDateAnnual(v){const n=v.replace(/[^0-9]/g,'');if(n.length===4)return parseInt(n.slice(0,2))+"/"+parseInt(n.slice(2,4));if(n.length===3)return parseInt(n.slice(0,1))+"/"+parseInt(n.slice(1,3));return v;}
    function formatNum(num) { return num ? Number(num).toLocaleString() : "0"; }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
    window.addAnnualItem=(k)=>{ const l=(k==='year'?'annualYear':'annualMonth'); data.years[data.currentYear][l].push({date:"",text:"",cost:0}); saveData(true); renderKakeibo(); };
    window.moveAnn=(k,idx,dir)=>{ const list=data.years[data.currentYear][k]; if(dir==='up'&&idx>0)[list[idx],list[idx-1]]=[list[idx-1],list[idx]]; saveData(true); renderKakeibo(); };
    window.updAnn=(l,i,k,v)=>{data.years[data.currentYear][l][i][k]=v;saveData(true)};
    window.delAnn=(l,i)=>{data.years[data.currentYear][l].splice(i,1);saveData(true);renderKakeibo()};
    window.toggleAnnualSub=(t)=>{if(t==='year')data.years[data.currentYear].isAnnualYearOpen=!data.years[data.currentYear].isAnnualYearOpen;else data.years[data.currentYear].isAnnualMonthOpen=!data.years[data.currentYear].isAnnualMonthOpen;saveData(true);renderKakeibo()};
    window.togBk=(i,m)=>{data.years[data.currentYear].months[m][i].isOpen=!data.years[data.currentYear].months[m][i].isOpen;saveData();renderKakeibo()};
    window.addCategoryBlock=(t)=>{ const m=data.years[data.currentYear].activeMonth||1; data.years[data.currentYear].months[m].push({type:t,title:t==='standard'?'ãƒªã‚¹ãƒˆ1':'ãƒªã‚¹ãƒˆ2',isOpen:true,items:[],balance:0,deposit:0}); saveData(); renderKakeibo(); };
    window.delBk=(i,m)=>{if(confirm("å‰Šé™¤ï¼Ÿ")){data.years[data.currentYear].months[m].splice(i,1);saveData();renderKakeibo()}};
    window.updBkTi=(i,v,m)=>{data.years[data.currentYear].months[m][i].title=v;saveData()};
    window.updBkVal=(i,k,v,m)=>{data.years[data.currentYear].months[m][i][k]=v;saveData()};
    window.addIt=(i,m)=>{ const b=data.years[data.currentYear].months[m][i]; if(!b.items)b.items=[]; b.items.push(b.type==='standard'?{date:"",name:"",plan:0,act:0}:{date:"",name:"",out:0,in:0}); saveData(); renderKakeibo(); };
    window.moveIt=(bi,ii,m,dir)=>{ const list=data.years[data.currentYear].months[m][bi].items; if(dir==='up'&&ii>0)[list[ii],list[ii-1]]=[list[ii-1],list[ii]]; saveData(); renderKakeibo(); };
    window.updIt=(b,i,k,v,m)=>{data.years[data.currentYear].months[m][b].items[i][k]=v;saveData()};
    window.delIt=(b,i,m)=>{data.years[data.currentYear].months[m][b].items.splice(i,1);saveData();renderKakeibo()};
    window.changeYear=()=>{data.currentYear=document.getElementById('year-select').value;renderKakeibo()};
    window.addNewYear=()=>{const n=prompt("è¥¿æš¦ã¯ï¼Ÿ(ä¾‹:2026)");if(n&&!data.years[n]){data.years[n]=createNewYearData();data.currentYear=n;saveData();renderKakeibo()}else if(data.years[n])alert("æ—¢ã«å­˜åœ¨ã—ã¾ã™")};
    window.deleteYear=()=>{if(Object.keys(data.years).length>1&&confirm("ç¾åœ¨ã®å¹´ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){delete data.years[data.currentYear];data.currentYear=Object.keys(data.years).sort()[0];saveData();renderKakeibo()}};
    window.shareDataText=async()=>{const s=JSON.stringify(data);if(navigator.share){try{await navigator.share({title:'å®¶è¨ˆç°¿ãƒ‡ãƒ¼ã‚¿',text:s});return}catch(e){}}window.location.href="mailto:?body="+encodeURIComponent(s);};
    window.exportDataToClipboard=()=>{const b=document.getElementById('backup-box');b.value=JSON.stringify(data);b.select();document.execCommand('copy');alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");};
    window.importDataFromText=()=>{const s=document.getElementById('backup-box').value.trim();if(s&&confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")){try{data=JSON.parse(s);saveData();renderKakeibo();alert("å®Œäº†ã—ã¾ã—ãŸ")}catch(e){alert("è§£æã‚¨ãƒ©ãƒ¼")}}};
</script>
</body>
</html>