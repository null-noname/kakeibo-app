<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>kakeibo_V6.08</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
    /* ----------------------------------------------------
       ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« (V6.08 ã‚¹ãƒãƒ›å¯¾å¿œç‰ˆ)
       ---------------------------------------------------- */
    body { 
        font-family: sans-serif; margin: 0; padding: 0; 
        background: #121212; color: #e0e0e0; 
        padding-bottom: 150px; 
        padding-top: calc(60px + env(safe-area-inset-top)); 
        user-select: none; 
    }
    .app-bar {
        position: fixed; top: 0; left: 0; width: 100%;
        height: calc(50px + env(safe-area-inset-top));
        padding-top: env(safe-area-inset-top);
        background: #1b5e20;
        display: flex; align-items: center; justify-content: space-between;
        padding-left: 15px; padding-right: 15px;
        box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 1000;
    }
    /* ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­— */
    .app-title { font-weight: bold; color: #fff; font-size: 1.1em; }
    
    .hamburger-btn { background: transparent; border: none; color: #fff; font-size: 2.0em; cursor: pointer; padding: 10px; }
    .container { padding: 10px; max-width: 600px; margin: 0 auto; }
    h2 { font-size: 1.2em; border-left: 6px solid #2e7d32; padding-left: 10px; margin: 20px 0 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }
    .btn-green { background: #2e7d32; color: #fff; border: 1px solid #4caf50; border-radius: 4px; padding: 8px 14px; font-size: 1em; }
    .btn-red { background: #c62828; color: #fff; border: 1px solid #e57373; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; }
    .btn-backup { background: #1565c0; color: #fff; border: 1px solid #42a5f5; border-radius: 4px; padding: 12px; font-size: 1.1em; width: 100%; margin-bottom: 15px; cursor: pointer; }
    .btn-backup-sub { background: #424242; color: #ccc; border: 1px solid #666; border-radius: 4px; padding: 12px; font-size: 1.1em; width: 100%; margin-bottom: 15px; cursor: pointer; }
    .btn-year-ctrl { padding: 6px 12px; font-size: 0.9em; border-radius: 4px; color: #fff; margin-left: 5px; cursor: pointer; }
    .bg-green { background: #2e7d32; border: 1px solid #4caf50; }
    .bg-red { background: #c62828; border: 1px solid #e57373; }
    .btn-toggle { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; width: 34px; height: 34px; font-weight: bold; font-size: 1.2em; margin-left: 8px; display: inline-flex; align-items: center; justify-content: center; }
    .add-row-btn { width: 100%; padding: 10px; margin-top: 5px; background: #2e7d32; color: #fff; border: 1px solid #4caf50; border-radius: 4px; font-size: 1.1em; cursor: pointer; }
    input, textarea { box-sizing: border-box; border: 1px solid #444; background: #2a2a2a; border-radius: 3px; color: #fff; font-size: 1.15em; padding: 2px; }
    textarea { width: 100%; color: #eee; resize: none; min-height: 2.0em; vertical-align: middle; word-break: break-all; }
    input { height: 2.0em; }
    input.day-input { text-align: center; width: 34px; font-family: monospace; font-weight: bold; padding: 2px 0; }
    input.date-input { text-align: center; width: 75px; font-family: monospace; font-weight: bold; }
    input.money-input { text-align: right; color: #80d8ff; width: 86px; font-family: monospace; font-weight: bold; letter-spacing: -0.5px; padding-right: 4px; font-size: 1.05em; }
    input.summary-input { text-align: right; color: #80d8ff; width: 120px; height: 2.5em; font-family: monospace; font-weight: bold; letter-spacing: -0.5px; padding-right: 6px; font-size: 1.3em; background: #333; border: 1px solid #555; border-radius: 4px; }
    @media screen and (max-width: 480px) { input.summary-input { width: 100%; font-size: 1.2em; } }
    #annual-section { background: #1e1e1e; padding: 10px; border-radius: 5px; border: 1px solid #333; }
    .annual-group { margin-bottom: 30px; } 
    .annual-header { font-weight: bold; color: #fff; border-bottom: 2px solid #2e7d32; margin-bottom: 10px; padding-bottom: 2px; font-size: 1.2em; display: flex; justify-content: space-between; align-items: center; }
    .year-controls { background: #1f1f1f; padding: 10px; margin: 15px 0; border-radius: 5px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    select { font-size: 1.2em; padding: 5px; background: #333; color: #fff; border: 1px solid #555; }
    .month-selector { display: flex; overflow-x: auto; background: #000; margin-bottom: 15px; border: 1px solid #333; padding: 5px 0; }
    .month-btn { flex: 0 0 auto; padding: 12px 18px; color: #888; border-right: 1px solid #222; cursor: pointer; }
    .month-btn.active { background: #2e7d32; color: #fff; font-weight: bold; border: 1px solid #fff; border-radius: 2px; }
    .category-block { background: #1e1e1e; padding: 10px; margin-bottom: 25px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); border: 1px solid #333; }
    .cat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background: #2c2c2c; padding: 8px; border-radius: 3px; border: 1px solid #444; }
    .cat-title-input { font-weight: bold; border: none !important; background: transparent !important; font-size: 1.4em; width: 60%; color: #fff; padding: 0; }
    .summary-area { display: flex; align-items: center; justify-content: space-around; background: #252525; padding: 10px 5px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #383838; }
    .summary-item { display: flex; align-items: center; }
    .summary-label { font-size: 1.1em; color: #ccc; margin-right: 10px; white-space: nowrap; }
    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; table-layout: fixed; font-size: 1em; }
    th { color: #aaa; font-weight: normal; font-size: 0.9em; text-align: center; padding-bottom: 2px; }
    td { vertical-align: top; padding: 0 1px; }
    .col-date-annual { width: 75px; } 
    .col-date-month { width: 55px; } 
    .col-money { width: 86px; } 
    .col-del { width: 30px; }
    .add-block-area { text-align: center; margin-top: 30px; border-top: 1px dashed #444; padding-top: 20px; }
    .big-btn { background: #2e7d32; color: #fff; padding: 14px 24px; border: 1px solid #4caf50; border-radius: 5px; font-size: 1.1em; margin: 5px; width: 85%; }
    .hidden { display: none !important; }
    .total-row td { vertical-align: middle; }
    .total-val-box { background: #2a2a2a; border: 1px solid #444; border-radius: 3px; text-align: right; color: #fff; font-weight: bold; font-family: monospace; font-size: 1.05em; padding: 4px; height: 2.0em; display: flex; align-items: center; justify-content: flex-end; letter-spacing: -0.5px; }
    .total-label { text-align: center; font-weight: bold; color: #fff; background: transparent; border: none; font-size: 1.1em; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: #222; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-align: center; }
    .modal-header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 20px; }
    .modal-title { font-size: 1.2em; font-weight: bold; color: #fff; margin: 0; }
    .modal-close-btn { background: transparent; border: none; color: #fff; font-size: 2em; line-height: 1; cursor: pointer; padding: 0 10px; }
    .backup-textarea { width: 100%; height: 80px; background: #000; color: #aaa; border: 1px solid #555; font-size: 0.8em; margin-bottom: 10px; word-break: break-all; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    #sync-status { position:fixed; bottom:10px; right:10px; font-size:0.8em; color:#aaa; background:#222; padding:4px 8px; border-radius:4px; opacity:0.7; z-index:9999; }

    @media screen and (max-width: 480px) {
        .summary-area { flex-direction: column; align-items: flex-start; }
        .summary-item { width: 100%; margin-bottom: 8px; }
        .summary-label { margin-right: 0; margin-bottom: 2px; }
    }
</style>
</head>
<body>

<div class="app-bar">
    <div class="app-title">å®¶è¨ˆç°¿</div>
    <button class="hamburger-btn" onclick="openMenu()">â˜°</button>
</div>

<div class="container">
    <h2>
        å›ºå®šè²»
        <button class="btn-toggle" onclick="toggleMainAnnual()" id="annual-main-toggle">ï¼</button>
    </h2>
    <div id="annual-section">
        <div class="annual-group">
            <div class="annual-header">
                <span>å¹´é–“</span>
                <button class="btn-toggle" onclick="toggleAnnualSub('year')" id="btn-annual-year">ï¼</button>
            </div>
            <div id="content-annual-year">
                <div id="annual-table-year"></div>
                <button class="add-row-btn" onclick="addAnnualItem('year')">è¿½åŠ </button>
            </div>
        </div>
        <div class="annual-group">
            <div class="annual-header">
                <span>æœˆé–“</span>
                <button class="btn-toggle" onclick="toggleAnnualSub('month')" id="btn-annual-month">ï¼</button>
            </div>
            <div id="content-annual-month">
                <div id="annual-table-month"></div>
                <button class="add-row-btn" onclick="addAnnualItem('month')">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <div class="year-controls">
        <select id="year-select" onchange="changeYear()"></select>
        <div>
            <button class="btn-year-ctrl bg-green" onclick="addNewYear()">è¿½åŠ </button>
            <button class="btn-year-ctrl bg-red" onclick="deleteYear()">å‰Šé™¤</button>
        </div>
    </div>

    <div class="month-selector" id="month-tabs"></div>
    <h2 id="monthly-header-title">1æœˆã®åæ”¯</h2> 
    <div id="monthly-container"></div>

    <div class="add-block-area">
        <button class="big-btn" onclick="addCategoryBlock('standard')">ãƒªã‚¹ãƒˆ1ã‚’è¿½åŠ </button>
        <button class="big-btn" onclick="addCategoryBlock('detail')">ãƒªã‚¹ãƒˆ2ã‚’è¿½åŠ </button>
    </div>
</div>

<div id="menu-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header-row">
            <div class="modal-title">è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</div>
            <button class="modal-close-btn" onclick="closeMenu()">Ã—</button>
        </div>
        <p style="color:#aaa; font-size:0.9em; margin-bottom:15px; text-align:left;">
            ã€é‡è¦ã€‘ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã•ã‚Œã¾ã™ãŒã€å¿µã®ãŸã‚æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚å¯èƒ½ã§ã™ã€‚<br>
        </p>
        <button class="btn-backup" onclick="shareDataText()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã— (ãƒ†ã‚­ã‚¹ãƒˆ)</button>
        <button class="btn-backup" style="background:#00695c; border-color:#00897b;" onclick="exportDataToClipboard()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
        <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
        <textarea id="backup-box" class="backup-textarea" placeholder="ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦å¾©å…ƒ"></textarea>
        <button class="btn-backup-sub" onclick="importDataFromText()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (å¾©å…ƒ)</button>
    </div>
</div>

<div id="sync-status">åŒæœŸå¾…æ©Ÿä¸­...</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCT_VvEPzGCPRLLFnzQuwArsYn2JnUR_fg",
        authDomain: "kakeibo-app-92bb4.firebaseapp.com",
        databaseURL: "https://kakeibo-app-92bb4-default-rtdb.firebaseio.com",
        projectId: "kakeibo-app-92bb4",
        storageBucket: "kakeibo-app-92bb4.firebasestorage.app",
        messagingSenderId: "45651637804",
        appId: "1:45651637804:web:f30ba95891d28538a14389"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const dbRef = db.ref('kakeiboData');

    const initialData = {
        currentYear: "2025",
        lastViewedMonth: 1, 
        showAnnual: true,
        years: { "2025": createNewYearData() }
    };

    let data = JSON.parse(JSON.stringify(initialData));
    let currentMonth = 1;
    let isDataLoaded = false;

    // --- åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ ---
    dbRef.on('value', (snapshot) => {
        const val = snapshot.val();
        const statusEl = document.getElementById('sync-status');
        
        if (val) {
            data = val; 
            if(!data.years) data = JSON.parse(JSON.stringify(initialData));
        } else {
            const local = localStorage.getItem('kakeiboDataV7_Backup');
            if(local) {
                data = JSON.parse(local);
                saveData(false);
            } else {
                data = JSON.parse(JSON.stringify(initialData));
            }
        }
        currentMonth = data.lastViewedMonth || 1;
        isDataLoaded = true;
        try {
            render();
            if(statusEl) {
                statusEl.innerText = "â— åŒæœŸå®Œäº†";
                setTimeout(() => { statusEl.innerText = ""; }, 2000);
            }
        } catch(e) {
            console.error("Render Error:", e);
        }
    });

    function saveData(syncAnnual = false) {
        if(!isDataLoaded) return;
        if(syncAnnual) {
            const currentY = data.years[data.currentYear];
            Object.keys(data.years).forEach(y => {
                if(y !== data.currentYear && data.years[y]) {
                    data.years[y].annualYear = JSON.parse(JSON.stringify(currentY.annualYear));
                    data.years[y].annualMonth = JSON.parse(JSON.stringify(currentY.annualMonth));
                    data.years[y].isAnnualYearOpen = currentY.isAnnualYearOpen;
                    data.years[y].isAnnualMonthOpen = currentY.isAnnualMonthOpen;
                }
            });
        }
        data.lastViewedMonth = currentMonth;
        dbRef.set(data).catch(err => {});
        localStorage.setItem('kakeiboDataV7_Backup', JSON.stringify(data));
        
        const el = document.getElementById('sync-status');
        if(el) el.innerText = "â†‘ é€ä¿¡ä¸­...";
    }

    // --- åŸºæœ¬æ©Ÿèƒ½ ---
    function createNewYearData() {
        let months = {};
        for(let i=1; i<=12; i++){
            months[i] = [
                { type: "standard", title: "é€šå¸³", isOpen: true, items: [], balance: 0, deposit: 0 },
                { type: "standard", title: "è²¡å¸ƒ", isOpen: true, items: [], balance: 0, deposit: 0 },
                { type: "detail", title: "ç«¶é¦¬", isOpen: true, items: [] }
            ];
        }
        return {
            annualYear: [], annualMonth: [],
            isAnnualYearOpen: true, isAnnualMonthOpen: true,
            months: months
        };
    }

    window.openMenu = () => { document.getElementById('menu-modal').classList.remove('hidden'); document.getElementById('backup-box').value = ""; };
    window.closeMenu = () => { document.getElementById('menu-modal').classList.add('hidden'); };
    window.shareDataText = async () => {
        const str = JSON.stringify(data);
        if (navigator.share) { try { await navigator.share({ title: 'å®¶è¨ˆç°¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', text: str }); return; } catch (err) { } }
        window.location.href = "mailto:?subject=å®¶è¨ˆç°¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—&body=" + encodeURIComponent(str);
    };
    window.exportDataToClipboard = () => {
        const str = JSON.stringify(data);
        const box = document.getElementById('backup-box');
        box.value = str; box.select(); document.execCommand('copy');
        alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    };
    window.importDataFromText = () => {
        const str = document.getElementById('backup-box').value.trim();
        if(!str) { alert("ãƒœãƒƒã‚¯ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return; }
        if(!confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            data = JSON.parse(str);
            currentMonth = data.lastViewedMonth || 1;
            saveData(); 
            alert("å¾©å…ƒã—ã€åŒæœŸã—ã¾ã—ãŸï¼"); closeMenu();
        } catch(e) { alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
    };

    function formatDateAnnual(val) {
        const nums = val.replace(/[^0-9]/g, '');
        if (nums.length === 4) return parseInt(nums.slice(0,2)) + "/" + parseInt(nums.slice(2,4));
        if (nums.length === 3) return parseInt(nums.slice(0,1)) + "/" + parseInt(nums.slice(1,3));
        return val;
    }
    function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }
    function formatNum(num) { return num ? Number(num).toLocaleString() : "0"; }

    function updateTotalDisplay(bIdx) {
        if(!data.years[data.currentYear] || !data.years[data.currentYear].months[currentMonth]) return;
        const block = data.years[data.currentYear].months[currentMonth][bIdx];
        let s1=0, s2=0;
        const items = block.items || [];
        if(block.type === 'standard') { items.forEach(i => { s1 += Number(i.plan); s2 += Number(i.act); }); } 
        else { items.forEach(i => { s1 += Number(i.out); s2 += Number(i.in); }); }
        const el1 = document.getElementById(`t1-${bIdx}`);
        const el2 = document.getElementById(`t2-${bIdx}`);
        if(el1) el1.innerText = formatNum(s1);
        if(el2) el2.innerText = formatNum(s2);
    }

    function render() {
        if(!isDataLoaded) return; 
        const yearSelect = document.getElementById('year-select');
        yearSelect.innerHTML = '';
        const sortedYears = Object.keys(data.years).sort();
        if(sortedYears.length===0){ data.years["2025"]=createNewYearData(); data.currentYear="2025"; sortedYears.push("2025"); }
        if(!data.years[data.currentYear]) data.currentYear=sortedYears[0];
        
        sortedYears.forEach(y=>{ 
            const op=document.createElement('option'); op.value=y; op.innerText=y+"å¹´"; 
            if(y===data.currentYear)op.selected=true; 
            yearSelect.appendChild(op); 
        });

        const yearData = data.years[data.currentYear];
        const annualSec = document.getElementById('annual-section');
        const toggleBtn = document.getElementById('annual-main-toggle');
        if(data.showAnnual){ annualSec.classList.remove('hidden'); toggleBtn.innerText="ï¼"; } else { annualSec.classList.add('hidden'); toggleBtn.innerText="ï¼‹"; }
        const cY=document.getElementById('content-annual-year'), bY=document.getElementById('btn-annual-year');
        if(yearData.isAnnualYearOpen!==false){ cY.classList.remove('hidden'); bY.innerText="ï¼"; } else { cY.classList.add('hidden'); bY.innerText="ï¼‹"; }
        const cM=document.getElementById('content-annual-month'), bM=document.getElementById('btn-annual-month');
        if(yearData.isAnnualMonthOpen!==false){ cM.classList.remove('hidden'); bM.innerText="ï¼"; } else { cM.classList.add('hidden'); bM.innerText="ï¼‹"; }

        renderAnnualTable('annual-table-year', yearData.annualYear, 'annualYear', 'yearMode');
        renderAnnualTable('annual-table-month', yearData.annualMonth, 'annualMonth', 'monthMode');

        const tabs=document.getElementById('month-tabs'); tabs.innerHTML='';
        for(let i=1; i<=12; i++){ 
            const d=document.createElement('div'); 
            d.className=`month-btn ${currentMonth===i?'active':''}`;
            d.innerText=i+"æœˆ"; 
            d.onclick=()=>{ currentMonth=i; saveData(); render(); }; 
            tabs.appendChild(d);
        }
        document.getElementById('monthly-header-title').innerText = `${currentMonth}æœˆã®åæ”¯`;
        renderMonthlyBlocks(yearData);
    }

    // --- é«˜é€ŸåŒ–ã®ãŸã‚ã€cb(ä¿å­˜)ã‚’oninputã‹ã‚‰onblur/onchangeã«ç§»å‹• ---
    function renderAnnualTable(cid, list, key, mode) {
        const c=document.getElementById(cid); c.innerHTML='';
        const t=document.createElement('table');
        if(mode==='yearMode') t.innerHTML=`<thead><tr><th class="col-date-annual">æ—¥ä»˜</th><th>å†…å®¹</th><th class="col-money">é‡‘é¡</th><th class="col-del"></th></tr></thead>`;
        else t.innerHTML=`<thead><tr><th class="col-date-month">æ—¥ä»˜</th><th>å†…å®¹</th><th class="col-money">é‡‘é¡</th><th class="col-del"></th></tr></thead>`;
        const tb=document.createElement('tbody');
        if(!list) list = []; 
        list.forEach((item,idx)=>{
            const tr=document.createElement('tr'); const tdD=document.createElement('td');
            if(mode==='yearMode') tdD.appendChild(createInp(item.date, v=>updAnn(key,idx,'date',v), 'date'));
            else { const w=document.createElement('div'); w.style.display="flex"; w.style.alignItems="center"; w.style.justifyContent="center"; w.append(createInp(item.date, v=>updAnn(key,idx,'date',v), 'day'), createSuf("æ—¥")); tdD.appendChild(w); }
            const tdTx=document.createElement('td'); tdTx.appendChild(createTxt(item.text, v=>updAnn(key,idx,'text',v)));
            const tdC=document.createElement('td'); tdC.appendChild(createMon(item.cost, v=>updAnn(key,idx,'cost',v)));
            const tdDel=document.createElement('td'); tdDel.innerHTML=`<button class="del-icon-btn" onclick="delAnn('${key}',${idx})">Ã—</button>`;
            tr.append(tdD,tdTx,tdC,tdDel); tb.appendChild(tr); setTimeout(()=>autoResize(tdTx.firstChild),0);
        });
        t.appendChild(tb); c.appendChild(t);
    }

    function renderMonthlyBlocks(yd) {
        const c=document.getElementById('monthly-container'); c.innerHTML='';
        if(!yd.months[currentMonth]) yd.months[currentMonth] = [];
        
        yd.months[currentMonth].forEach((b,bi)=>{
            const d=document.createElement('div'); d.className='category-block';
            d.innerHTML=`<div class="cat-header"><input type="text" class="cat-title-input" value="${b.title}" onchange="updBkTi(${bi},this.value)"><div style="display:flex;align-items:center;"><button class="btn-red" onclick="delBk(${bi})">å‰Šé™¤</button><button class="btn-toggle" onclick="togBk(${bi})">${b.isOpen!==false?'ï¼':'ï¼‹'}</button></div></div>`;
            const contentDiv = document.createElement('div'); 
            if(b.isOpen===false) contentDiv.classList.add('hidden');
            
            if(b.type==='standard') {
                if(b.balance === undefined) b.balance = 0;
                if(b.deposit === undefined) b.deposit = 0;
                
                const summaryDiv = document.createElement('div'); summaryDiv.className = 'summary-area';
                const item1 = document.createElement('div'); item1.className = 'summary-item';
                const label1 = document.createElement('div'); label1.className = 'summary-label'; label1.innerText = 'æ®‹é«˜';
                item1.appendChild(label1);
                const balInp = createMon(b.balance, v=>updBkVal(bi, 'balance', v), null, true);
                balInp.id = `balance-input-${currentMonth}-${bi}`;
                item1.appendChild(balInp);

                const item2 = document.createElement('div'); item2.className = 'summary-item';
                const label2 = document.createElement('div'); label2.className = 'summary-label'; label2.innerText = 'å…¥ã‚Œã‚‹é¡';
                item2.appendChild(label2);
                const depInp = createMon(b.deposit, v=>updBkVal(bi, 'deposit', v), null, true);
                depInp.id = `deposit-input-${currentMonth}-${bi}`;
                item2.appendChild(depInp);
                summaryDiv.appendChild(item1); summaryDiv.appendChild(item2); contentDiv.appendChild(summaryDiv);
            }

            const t=document.createElement('table'); const tb=document.createElement('tbody');
            if(b.type==='standard') {
                t.innerHTML=`<thead><tr><th class="col-date-month">æ—¥ä»˜</th><th>å†…å®¹</th><th class="col-money">äºˆå®šé¡</th><th class="col-money">ç¢ºå®šé¡</th><th class="col-del"></th></tr></thead>`;
            } else {
                t.innerHTML=`<thead><tr><th class="col-date-month">æ—¥ä»˜</th><th>é‡è³å</th><th class="col-money">å…¥é‡‘</th><th class="col-money">æ‰•æˆ»</th><th class="col-del"></th></tr></thead>`;
            }
            const items = b.items || [];
            items.forEach((it,ii)=>{
                const tr=document.createElement('tr');
                const tdD=document.createElement('td'); const w=document.createElement('div'); w.style.display="flex"; w.style.alignItems="center"; w.style.justifyContent="center";
                w.append(createInp(it.date, v=>updIt(bi,ii,'date',v), 'day'), createSuf("æ—¥")); tdD.appendChild(w);
                const tdN=document.createElement('td'); tdN.appendChild(createTxt(it.name, v=>updIt(bi,ii,'name',v)));
                tr.append(tdD, tdN);
                if(b.type==='standard'){
                    const td1=document.createElement('td'); td1.appendChild(createMon(it.plan, v=>updIt(bi,ii,'plan',v), ()=>updateTotalDisplay(bi)));
                    const td2=document.createElement('td'); td2.appendChild(createMon(it.act, v=>updIt(bi,ii,'act',v), ()=>updateTotalDisplay(bi)));
                    tr.append(td1, td2);
                } else {
                    const td1=document.createElement('td'); td1.appendChild(createMon(it.out, v=>updIt(bi,ii,'out',v), ()=>updateTotalDisplay(bi)));
                    const td2=document.createElement('td'); td2.appendChild(createMon(it.in, v=>updIt(bi,ii,'in',v), ()=>updateTotalDisplay(bi)));
                    tr.append(td1, td2);
                }
                const tdDel=document.createElement('td'); tdDel.innerHTML=`<button class="del-icon-btn" onclick="delIt(${bi},${ii})">Ã—</button>`;
                tr.appendChild(tdDel); tb.appendChild(tr); setTimeout(()=>autoResize(tdN.firstChild),0);
            });

            const trTotal = document.createElement('tr'); trTotal.className = 'total-row';
            let s1=0, s2=0;
            if(b.type==='standard'){ 
                items.forEach(i=>{s1+=Number(i.plan);s2+=Number(i.act)});
                trTotal.innerHTML=`<td class="total-label">åˆè¨ˆ</td><td></td><td><div class="total-val-box" id="t1-${bi}">${formatNum(s1)}</div></td><td><div class="total-val-box" id="t2-${bi}">${formatNum(s2)}</div></td><td></td>`; 
            } else { 
                items.forEach(i=>{s1+=Number(i.out);s2+=Number(i.in)});
                trTotal.innerHTML=`<td></td><td class="total-label">åˆè¨ˆ</td><td><div class="total-val-box" id="t1-${bi}">${formatNum(s1)}</div></td><td><div class="total-val-box" id="t2-${bi}">${formatNum(s2)}</div></td><td></td>`; 
            }
            tb.appendChild(trTotal); t.appendChild(tb); contentDiv.appendChild(t); 
            const ab=document.createElement('button'); ab.className='add-row-btn'; ab.innerText='è¿½åŠ '; ab.onclick=()=>addIt(bi); 
            contentDiv.appendChild(ab);
            d.appendChild(contentDiv); c.appendChild(d);
        });
    }

    // ã€ä¿®æ­£ã€‘æ•°å­—å…¥åŠ›ï¼šcbï¼ˆä¿å­˜ï¼‰ã¯ onblurï¼ˆå…¥åŠ›ã‚’çµ‚ãˆãŸæ™‚ï¼‰ã ã‘å‘¼ã¶
    function createInp(val, cb, type) {
        const i=document.createElement('input'); i.value=val||"";
        if(type==='date') { 
            i.type="text"; i.className="date-input"; 
            // å…¥åŠ›ä¸­ã¯ä¿å­˜ã—ãªã„
            i.oninput=function(){}; 
            i.onblur=function(){this.value=formatDateAnnual(this.value); cb(this.value)}; 
        }
        else { 
            i.type="tel"; i.className="day-input"; i.setAttribute("maxlength","2"); 
            // å…¥åŠ›ä¸­ã¯æ•°å­—ãƒã‚§ãƒƒã‚¯ã ã‘ï¼ˆä¿å­˜ã—ãªã„ï¼‰
            i.oninput=function(){
                let v=this.value.replace(/[^0-9]/g,'');
                if(Number(v)>31)v="31";
                if(this.value!==v)this.value=v;
            };
            i.onblur=function(){ cb(this.value); };
        }
        return i;
    }
    function createSuf(t){const s=document.createElement('span');s.className="day-suffix";s.innerText=t;return s;}
    
    // ã€ä¿®æ­£ã€‘ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼šcbï¼ˆä¿å­˜ï¼‰ã¯ onblur ã ã‘å‘¼ã¶
    function createTxt(v,cb){
        const t=document.createElement('textarea'); t.value=v||""; t.rows=1;
        t.oninput=function(){ autoResize(this); }; // é«˜ã•èª¿æ•´ã ã‘
        t.onblur=function(){ cb(this.value); };    // ä¿å­˜ã¯å¤–ã‚ŒãŸæ™‚
        return t;
    }
    
    // ã€ä¿®æ­£æ¸ˆã¿ã€‘é‡‘é¡å…¥åŠ›ï¼šå…ƒã€…onblurãªã®ã§OK
    function createMon(v, cb, bCb, isBig = false){
        const i=document.createElement('input');
        i.type="tel"; 
        i.className = isBig ? "summary-input" : "money-input";
        i.value = (v === 0 || v === "0") ? "" : Number(v).toLocaleString();
        
        i.onfocus=function(){ this.value=this.value.replace(/,/g,''); this.select(); };
        i.oninput=function(){
             let raw = this.value.replace(/[^0-9\-]/g, '');
             if(raw.lastIndexOf('-') > 0) raw = raw.replace(/-/g, '');
             const isMinus = raw.startsWith('-');
             let numPart = isMinus ? raw.slice(1) : raw;
             if(numPart.length > 6) { numPart = numPart.slice(0, 6); raw = isMinus ? '-' + numPart : numPart; }
             if(this.value !== raw) this.value = raw;
        };
        i.onblur=function(){
            let val = this.value.replace(/,/g,'').replace(/[ï¼-ï¼™]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
            val = val.replace(/[^0-9\-]/g, '');
            const n = parseFloat(val); 
            if (isNaN(n) || n === 0) { cb(0); this.value = ""; } 
            else { 
                if(n > 999999) { cb(999999); this.value = "999,999"; }
                else if(n < -999999) { cb(-999999); this.value = "-999,999"; }
                else { cb(n); this.value = n.toLocaleString(); }
            }
            if(bCb) bCb();
        };
        return i;
    }

    // --- æ“ä½œ ---
    window.toggleMainAnnual=()=>{data.showAnnual=!data.showAnnual;saveData();render()};
    window.toggleAnnualSub=(t)=>{if(t==='year')data.years[data.currentYear].isAnnualYearOpen=!data.years[data.currentYear].isAnnualYearOpen;else data.years[data.currentYear].isAnnualMonthOpen=!data.years[data.currentYear].isAnnualMonthOpen;saveData(true);render()};
    window.togBk=(i)=>{const b=data.years[data.currentYear].months[currentMonth][i];b.isOpen=!b.isOpen;saveData();render()};
    window.addAnnualItem=(k)=>{const l=(k==='year'||k==='annualYear')?'annualYear':'annualMonth';data.years[data.currentYear][l].push({date:"",text:"",cost:0});saveData(true);render()};
    window.updAnn=(l,i,k,v)=>{data.years[data.currentYear][l][i][k]=v;saveData(true)};
    window.delAnn=(l,i)=>{data.years[data.currentYear][l].splice(i,1);saveData(true);render()};
    window.addCategoryBlock=(t)=>{const T=t==='standard'?'ãƒªã‚¹ãƒˆ1':'ãƒªã‚¹ãƒˆ2';data.years[data.currentYear].months[currentMonth].push({type:t,title:T,isOpen:true,items:[], balance:0, deposit:0});saveData();render()};
    window.delBk=(i)=>{if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){data.years[data.currentYear].months[currentMonth].splice(i,1);saveData();render()}};
    window.updBkTi=(i,v)=>{data.years[data.currentYear].months[currentMonth][i].title=v;saveData()};
    window.updBkVal=(i,key,v)=>{data.years[data.currentYear].months[currentMonth][i][key]=v;saveData()};
    
    window.addIt=(i)=>{
        const b=data.years[data.currentYear].months[currentMonth][i];
        if(!b.items) b.items = []; 
        if(b.type==='standard')b.items.push({date:"",name:"",plan:0,act:0});else b.items.push({date:"",name:"",out:0,in:0});
        saveData();render();
    };
    
    window.updIt=(b,i,k,v)=>{data.years[data.currentYear].months[currentMonth][b].items[i][k]=v;saveData()};
    window.delIt=(b,i)=>{data.years[data.currentYear].months[currentMonth][b].items.splice(i,1);saveData();render()};
    window.changeYear=()=>{data.currentYear=document.getElementById('year-select').value;render()};
    window.addNewYear=()=>{const n=prompt("è¿½åŠ ã™ã‚‹è¥¿æš¦ï¼ˆä¾‹: 2026ï¼‰");if(n&&!data.years[n]){const c=data.years[data.currentYear];const ny=createNewYearData();ny.annualYear=JSON.parse(JSON.stringify(c.annualYear));ny.annualMonth=JSON.parse(JSON.stringify(c.annualMonth));ny.isAnnualYearOpen=c.isAnnualYearOpen;ny.isAnnualMonthOpen=c.isAnnualMonthOpen;data.years[n]=ny;data.currentYear=n;saveData();render();alert(n+"å¹´ã‚’è¿½åŠ ã—ã¾ã—ãŸ")}else if(data.years[n])alert("ãã®å¹´ã¯æ—¢ã«ã‚ã‚Šã¾ã™")};
    window.deleteYear=()=>{if(Object.keys(data.years).length<=1){alert("å‰Šé™¤ã§ãã¾ã›ã‚“");return}if(confirm(data.currentYear+"å¹´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){delete data.years[data.currentYear];data.currentYear=Object.keys(data.years).sort()[0];saveData();render()}};

    document.getElementById('sync-status').innerText = "æ¥ç¶šä¸­...";
</script>
</body>
</html>